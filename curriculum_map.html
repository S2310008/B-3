<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…å ±å­¦é ˜åŸŸ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ç³»çµ±å›³</title>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; /* å¤‰æ›´ç‚¹: bodyã®marginã‚’0ã« */
            padding: 20px; /* å¤‰æ›´ç‚¹: ä»£ã‚ã‚Šã«paddingã‚’è¨­å®š */
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            box-sizing: border-box; /* å¤‰æ›´ç‚¹ */
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .map-container {
            max-width: 1400px;
            width: 100%; /* å¤‰æ›´ç‚¹: å¸¸ã«è¦ªè¦ç´ ã®å¹…ã«åˆã‚ã›ã‚‹ */
            box-sizing: border-box; /* å¤‰æ›´ç‚¹: paddingã‚’å¹…è¨ˆç®—ã«å«ã‚ã‚‹ */
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ãƒ¡ã‚¸ãƒ£ãƒ¼é¸æŠUI */
        .major-selector {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e6f7ff;
            border-radius: 5px;
            border: 1px solid #cceeff;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .major-selector label {
            font-weight: bold;
            margin-right: 10px;
            color: #0056b3;
        }
        .major-selector select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #007bff;
            font-size: 1em;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%20197.8L145.2%2048.7%203.2%20197.8c-4.6%204.6-12%204.6-16.6%200l-16.6-16.6c-4.6-4.6-4.6-12%200-16.6l155.4-155.4c4.6-4.6%2012-4.6%2016.6%200l155.4%20155.4c4.6%204.6%204.6%2012%200%2016.6l-16.6%2016.6c-4.6%204.7-12%204.7-16.6.1z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 0.65em auto;
            padding-right: 2.5em;
        }


        /* CSS Grid å®šç¾© */
        .curriculum-map-grid {
            display: grid;
            grid-template-columns: 80px repeat(13, minmax(100px, 1fr)); /* åˆ—å®šç¾©ã¯ç¶­æŒ */
            grid-template-rows: auto repeat(20, minmax(30px, auto));
            gap: 5px;
            padding: 10px;
            border: 1px solid #ccc;
            /* min-width: 1400px; */ /* ğŸ—‘ï¸ å¤‰æ›´ç‚¹: ã“ã®è¡Œã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ */
            overflow-x: auto; /* å¤‰æ›´ç‚¹: ã¯ã¿å‡ºãŸå ´åˆã¯ã‚°ãƒªãƒƒãƒ‰å†…ã‚’æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }

        /* ã‚°ãƒªãƒƒãƒ‰ã®è»¸ãƒ©ãƒ™ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .grid-label {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #666;
            border: 1px solid #eee;
            background-color: #f8f8f8;
            font-size: 0.9em;
            overflow: hidden;
            white-space: nowrap;
        }
        .grid-label.grid-column-header {
            background-color: #e9e9e9;
            font-size: 0.95em;
            padding: 5px;
            border-bottom: 2px solid #ccc;
        }
        .grid-label.semester-num-label {
            background-color: #e2e2e2;
            font-size: 1em;
            color: #333;
            border-right: 1px solid #bbb;
            border-bottom: 1px solid #eee;
            padding: 5px;
            white-space: pre-wrap;
            line-height: 1.2;
        }
        .grid-label.quarter-label {
            background-color: #f8f8f8;
            font-size: 0.85em;
            color: #666;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        /* ç§‘ç›®ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .subject-block {
            background-color: #e0f7fa;
            border: 1px solid #a7d9e7;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px 10px;
            text-align: center;
            /* âœ¨ å¤‰æ›´ç‚¹: æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¯å¤‰ã« */
            font-size: clamp(0.7em, 1.5vw, 0.9em);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-height: 40px; /* å¤‰æ›´ç‚¹: å°ã•ããªã‚Šã™ããªã„ã‚ˆã†ã«æœ€å°ã®é«˜ã•ã‚’è¨­å®š */
        }
        .subject-block:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .subject-block a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .subject-block a:hover {
            color: #0056b3;
        }
        .subject-block .block-code {
            font-size: 0.8em; /* å¤‰æ›´ç‚¹: è¦ªè¦ç´ ã«å¯¾ã™ã‚‹ç›¸å¯¾çš„ãªã‚µã‚¤ã‚ºã« */
            color: #666;
            margin-top: 3px;
        }

        /* ç§‘ç›®ç¨®é¡ã«å¿œã˜ãŸè‰²åˆ†ã‘ */
        .type-å¿…ä¿®ç§‘ç›® { background-color: #ffcdd2; border-color: #ef9a9a; }
        .type-é¸æŠå¿…ä¿®ç§‘ç›® { background-color: #ffe0b2; border-color: #ffcc80; }
        .type-é¸æŠç§‘ç›® { background-color: #c8e6c9; border-color: #a5d6a7; }
        .type-ãƒ¡ã‚¸ãƒ£ãƒ¼å…±æœ‰ç§‘ç›® { background-color: #bbdefb; border-color: #90caf9; }
        .type-ã‚¼ãƒŸãªã© { background-color: #e1bee7; border-color: #ce93d8; }
        .type-æ•™é¤Š { background-color: #d8e2dc; border-color: #a3b9b4; } 
        .type-å·¥å­¦åŸºç¤ { background-color: #d0f0c0; border-color: #90c280; }
        .type-æƒ…å ±åŸºç¤ { background-color: #c0d9e8; border-color: #8cb8cc; }
        .type-æƒ…å ±å¿œç”¨ { background-color: #e6e6fa; color: #6a5acd; border-color: #a7a7ff; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
        .loading-message, .error-message {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: #6c757d;
        }
        .error-message {
            color: #dc3545;
        }
        .back-to-search {
            display: block;
            text-align: center;
            margin-top: 20px;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        .back-to-search:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>æƒ…å ±å­¦é ˜åŸŸ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ç³»çµ±å›³</h1>

    <div class="major-selector">
        <label for="select-map-major">è¡¨ç¤ºãƒ¡ã‚¸ãƒ£ãƒ¼ã‚’é¸æŠ:</label>
        <select id="select-map-major">
            <option value="IS">ISãƒ¡ã‚¸ãƒ£ãƒ¼</option>
            <option value="NC">NCãƒ¡ã‚¸ãƒ£ãƒ¼</option>
            <option value="XD">XDãƒ¡ã‚¸ãƒ£ãƒ¼</option>
            <option value="ALL">ã™ã¹ã¦è¡¨ç¤º (å®Ÿé¨“çš„)</option> </select>
    </div>

    <div class="map-container">
        <div class="curriculum-map-grid" id="curriculum-map-grid">
            </div>
    </div>

    <div class="loading-message" id="loading">ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="error-message" id="error" style="display: none;"></div>
    
    <a href="index.html" class="back-to-search">â† æ¤œç´¢ç”»é¢ã«æˆ»ã‚‹</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // Firebaseã®è¨­å®šï¼ˆFirebase Consoleã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸæ­£ç¢ºãªfirebaseConfigã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyAMVDs2C7zKjame91CzT3LJkaz9WszBPHU",
            authDomain: "b3app-b0c29.firebaseapp.com",
            databaseURL: "https://b3app-b0c29-default-rtdb.firebaseio.com",
            projectId: "b3app-b0c29",
            storageBucket: "b3app-b0c29.firebasestorage.app",
            messagingSenderId: "1000910332829",
            appId: "1:1000910332829:web:a1bc233e638afed9b90574"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const mapGridElement = document.getElementById('curriculum-map-grid');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const selectMapMajorElement = document.getElementById('select-map-major'); // ãƒ¡ã‚¸ãƒ£ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³

        let allSubjectsData = {}; // /syllabus_subjects ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ãŸåŸºæœ¬æƒ…å ±)
        let allMetaData = {};     // /curriculum_meta ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ (æ±ç”¨ã‚¿ã‚°æƒ…å ±)
        let allMapPositionsData = {}; // /curriculum_map_positions ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ (ãƒ¡ã‚¸ãƒ£ãƒ¼ã”ã¨ã®ä½ç½®æƒ…å ±)

        // // â˜…ä¿®æ­£: ã‚°ãƒªãƒƒãƒ‰ã®è¡Œã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å®šç¾©ï¼ˆã‚ãªãŸã®æŒ‡ç¤ºã«å³å¯†ã«å¾“ã„å®šç¾©ï¼‰
        // const rowMap = {
        //     '3ã‚»ãƒ¡1Q': 1, // 3ã‚»ãƒ¡ã‚¹ã‚¿1QãŒ1è¡Œç›®ã‹ã‚‰
        //     '3ã‚»ãƒ¡2Q': 2, // 3ã‚»ãƒ¡ã‚¹ã‚¿2QãŒ2è¡Œç›®ã‹ã‚‰
        //     '4ã‚»ãƒ¡3Q': 3, // 4ã‚»ãƒ¡ã‚¹ã‚¿3QãŒ3è¡Œç›®ã‹ã‚‰
        //     '4ã‚»ãƒ¡4Q': 4, // 4ã‚»ãƒ¡ã‚¹ã‚¿4QãŒ4è¡Œç›®ã‹ã‚‰
        //     '5ã‚»ãƒ¡1Q': 5, // 5ã‚»ãƒ¡ã‚¹ã‚¿1QãŒ5è¡Œç›®ã‹ã‚‰
        //     '5ã‚»ãƒ¡2Q': 6, // 5ã‚»ãƒ¡ã‚¹ã‚¿2QãŒ6è¡Œç›®ã‹ã‚‰
        //     '6ã‚»ãƒ¡3Q': 7, // 6ã‚»ãƒ¡ã‚¹ã‚¿3QãŒ7è¡Œç›®ã‹ã‚‰
        //     '6ã‚»ãƒ¡4Q': 8, // 6ã‚»ãƒ¡ã‚¹ã‚¿4QãŒ8è¡Œç›®ã‹ã‚‰

        // };

        // ç§‘ç›®ç¨®é¡ï¼ˆè©³ç´°ï¼‰ã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (å‡¡ä¾‹ã®è‰²åˆ†ã‘ç”¨)
        function getSubjectTypeClass(type) {
            switch(type) {
                case 'å¿…ä¿®ç§‘ç›®': return 'type-å¿…ä¿®ç§‘ç›®';
                case 'é¸æŠå¿…ä¿®ç§‘ç›®': return 'type-é¸æŠå¿…ä¿®ç§‘ç›®';
                case 'é¸æŠç§‘ç›®': return 'type-é¸æŠç§‘ç›®';
                case 'ãƒ¡ã‚¸ãƒ£ãƒ¼å…±æœ‰ç§‘ç›®': return 'type-ãƒ¡ã‚¸ãƒ£ãƒ¼å…±æœ‰ç§‘ç›®';
                case 'ã‚¼ãƒŸãªã©': return 'type-ã‚¼ãƒŸãªã©';
                default: return '';
            }
        }

        // ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»ã™ã‚‹é–¢æ•°
        async function renderCurriculumMap(selectedMajor = 'IS') { // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ISãƒ¡ã‚¸ãƒ£ãƒ¼ã‚’è¡¨ç¤º
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                // Firebaseã‹ã‚‰3ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä¸¦è¡Œã—ã¦èª­ã¿è¾¼ã‚€
                const [syllabusSnapshot, metaSnapshot, mapPositionsSnapshot] = await Promise.all([
                    get(ref(database, 'syllabus_subjects')),
                    get(ref(database, 'curriculum_meta')),
                    get(ref(database, 'curriculum_map_positions'))
                ]);
                
                allSubjectsData = syllabusSnapshot.val() || {};
                allMetaData = metaSnapshot.val() || {};         
                allMapPositionsData = mapPositionsSnapshot.val() || {};

                loadingElement.style.display = 'none';
                mapGridElement.innerHTML = ''; // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢

                // ã‚°ãƒªãƒƒãƒ‰ã®è»¸ãƒ©ãƒ™ãƒ«ï¼ˆåˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’ç”Ÿæˆ
                const totalGridColumns = 13; // â˜…ä¿®æ­£: CSVã«åˆã‚ã›13åˆ—
                let columnHeaders = [];
                // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ã€ãƒ¡ã‚¸ãƒ£ãƒ¼ã”ã¨ã«ç•°ãªã‚‹ã®ã§selectedMajorã«å¿œã˜ã¦è¨­å®š
                // ã‚«ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã®å…·ä½“çš„ãªãƒ†ã‚­ã‚¹ãƒˆã¯ã€å„ãƒ¡ã‚¸ãƒ£ãƒ¼ã®å›³ã‚’è¦‹ã¦åŸ‹ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                if (selectedMajor === 'IS') {
                    columnHeaders = ['', 'åˆ—1', 'åˆ—2', 'åˆ—3', 'åˆ—4', 'åˆ—5', 'åˆ—6', 'åˆ—7', 'åˆ—8', 'åˆ—9', 'åˆ—10', 'åˆ—11', 'åˆ—12']; // ISãƒ¡ã‚¸ãƒ£ãƒ¼ã®åˆ—å
                } else if (selectedMajor === 'NC') {
                    columnHeaders = ['', 'åˆ—1', 'åˆ—2', 'åˆ—3', 'åˆ—4', 'åˆ—5', 'åˆ—6', 'åˆ—7', 'åˆ—8', 'åˆ—9', 'åˆ—10', 'åˆ—11', 'åˆ—12']; // NCãƒ¡ã‚¸ãƒ£ãƒ¼ã®åˆ—å
                } else if (selectedMajor === 'XD') {
                    columnHeaders = ['', 'åˆ—1', 'åˆ—2', 'åˆ—3', 'åˆ—4', 'åˆ—5', 'åˆ—6', 'åˆ—7', 'åˆ—8', 'åˆ—9', 'åˆ—10', 'åˆ—11', 'åˆ—12']; // XDãƒ¡ã‚¸ãƒ£ãƒ¼ã®åˆ—å
                } else { // ALLãªã©ã®å ´åˆã€æ±ç”¨çš„ãªãƒ˜ãƒƒãƒ€ãƒ¼
                    columnHeaders = ['', 'åˆ—1', 'åˆ—2', 'åˆ—3', 'åˆ—4', 'åˆ—5', 'åˆ—6', 'åˆ—7', 'åˆ—8', 'åˆ—9', 'åˆ—10', 'åˆ—11', 'åˆ—12'];
                }


                // ã‚°ãƒªãƒƒãƒ‰ã®CSSè¡Œæ•°ã‚‚å®šç¾©ï¼ˆrowMapã®æœ€å¤§å€¤ + 1 (ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ)ï¼‰
                // const maxRowNumber = Math.max(...Object.values(rowMap)) || 1; 
                // mapGridElement.style.gridTemplateRows = `auto repeat(${maxRowNumber}, minmax(30px, auto))`;
                mapGridElement.style.gridTemplateColumns = `80px repeat(12, minmax(100px, 1fr))`; // ãƒ©ãƒ™ãƒ«åˆ— + 12åˆ— (13åˆ—)


                // ã‚«ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1è¡Œç›®ï¼‰
                for (let col = 0; col < totalGridColumns; col++) {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'grid-label grid-column-header';
                    headerCell.style.gridRow = 1; // 1è¡Œç›®
                    headerCell.style.gridColumn = col + 1; // 1åˆ—ç›®ã‹ã‚‰é–‹å§‹
                    if (col > 0) { // æœ€åˆã®ã‚»ãƒ«ã¯ç©º
                        headerCell.textContent = columnHeaders[col];
                    }
                    mapGridElement.appendChild(headerCell);
                }


                // ç§‘ç›®ãƒ–ãƒ­ãƒƒã‚¯ã‚’é…ç½®
                for (const subjectCode in allSubjectsData) {
                    const subject = allSubjectsData[subjectCode]; // åŸºæœ¬æƒ…å ±
                    const meta = allMetaData[subjectCode] || {};   // æ±ç”¨ã‚¿ã‚°æƒ…å ±
                    const mapPos = allMapPositionsData[subjectCode] || {}; // ä½ç½®æƒ…å ±

                    let effectiveGridRowStartId = null;
                    let effectiveGridColStart = null;
                    let effectiveGridRowEndId = null;
                    let effectiveGridColEnd = null;
                    
                    // é¸æŠã•ã‚ŒãŸãƒ¡ã‚¸ãƒ£ãƒ¼ã«å¿œã˜ã¦ä½ç½®æƒ…å ±ã‚’å–å¾—
                    // ç§‘ç›®ãŒå­˜åœ¨ã—ãªã„ãƒ¡ã‚¸ãƒ£ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯ç©ºæ¬„ã«ãªã£ã¦ã„ã‚‹ã¯ãš
                    if (selectedMajor === 'IS' && mapPos['IS_row'] !== undefined && mapPos['IS_row'] !== null && mapPos['IS_row'] !== '') {
                        effectiveGridRowStartId = mapPos['IS_row'];
                        effectiveGridColStart = mapPos['IS_col'];
                        effectiveGridRowEndId = mapPos['IS_row_end'];
                        effectiveGridColEnd = mapPos['IS_col_end'];
                    } else if (selectedMajor === 'NC' && mapPos['NC_row'] !== undefined && mapPos['NC_row'] !== null && mapPos['NC_row'] !== '') {
                        effectiveGridRowStartId = mapPos['NC_row'];
                        effectiveGridColStart = mapPos['NC_col'];
                        effectiveGridRowEndId = mapPos['NC_row_end'];
                        effectiveGridColEnd = mapPos['NC_col_end'];
                    } else if (selectedMajor === 'XD' && mapPos['XD_row'] !== undefined && mapPos['XD_row'] !== null && mapPos['XD_row'] !== '') {
                        effectiveGridRowStartId = mapPos['XD_row'];
                        effectiveGridColStart = mapPos['XD_col'];
                        effectiveGridRowEndId = mapPos['XD_row_end'];
                        effectiveGridColEnd = mapPos['XD_col_end'];
                    } else if (selectedMajor === 'ALL') {
                        // ALLé¸æŠæ™‚ã¯ã€ã„ãšã‚Œã‹ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ã®ä½ç½®æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
                        if (mapPos['IS_row'] !== undefined && mapPos['IS_row'] !== null && mapPos['IS_row'] !== '') {
                            effectiveGridRowStartId = mapPos['IS_row'];
                            effectiveGridColStart = mapPos['IS_col'];
                            effectiveGridRowEndId = mapPos['IS_row_end'];
                            effectiveGridColEnd = mapPos['IS_col_end'];
                        } else if (mapPos['NC_row'] !== undefined && mapPos['NC_row'] !== null && mapPos['NC_row'] !== '') {
                            effectiveGridRowStartId = mapPos['NC_row'];
                            effectiveGridColStart = mapPos['NC_col'];
                            effectiveGridRowEndId = mapPos['NC_row_end'];
                            effectiveGridColEnd = mapPos['NC_col_end'];
                        } else if (mapPos['XD_row'] !== undefined && mapPos['XD_row'] !== null && mapPos['XD_row'] !== '') {
                            effectiveGridRowStartId = mapPos['XD_row'];
                            effectiveGridColStart = mapPos['XD_col'];
                            effectiveGridRowEndId = mapPos['XD_row_end'];
                            effectiveGridColEnd = mapPos['XD_col_end'];
                        } else {
                            // ã©ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ã«ã‚‚ç‰¹åŒ–ã—ãªã„ç§‘ç›® (æ±ç”¨ä½ç½®ãŒã‚ã‚Œã°ã€ã‚‚ã—CSVã«ã‚ã‚Œã°)
                            effectiveGridRowStartId = mapPos['grid_row_start'];
                            effectiveGridColStart = mapPos['grid_column_start'];
                            effectiveGridRowEndId = mapPos['grid_row_end'];
                            effectiveGridColEnd = mapPos['grid_column_end'];
                        }
                    } else {
                        // é¸æŠã•ã‚ŒãŸãƒ¡ã‚¸ãƒ£ãƒ¼ç”¨ã®ä½ç½®æƒ…å ±ãŒãªã„ã€ã‹ã¤ALLã§ã‚‚ãªã„å ´åˆã€ã“ã®ç§‘ç›®ã¯è¡¨ç¤ºã—ãªã„
                        console.log(`æƒ…å ±: ç§‘ç›® ${subjectCode} ã¯é¸æŠã•ã‚ŒãŸãƒ¡ã‚¸ãƒ£ãƒ¼ (${selectedMajor}) ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å›³ä¸Šã§ã®ä½ç½®æƒ…å ±ãŒãªã„ãŸã‚è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
                        continue;
                    }
                    
                    const subjectDetailedType = mapPos['ç§‘ç›®è©³ç´°'] || ''; // CSVã®ã€Œç§‘ç›®è©³ç´°ã€åˆ—ã‚’å‡¡ä¾‹ã®è‰²åˆ†ã‘ã«ä½¿ã†

                    // ä½ç½®æƒ…å ±ãŒæƒã£ã¦ã„ã‚‹ç§‘ç›®ã®ã¿æç”»
                    if (effectiveGridRowStartId && effectiveGridColStart) { 
                        // CSSã‚°ãƒªãƒƒãƒ‰ã®è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(1è¡Œç›®)ãŒã‚ã‚‹ã®ã§ã€CSVã®è¡Œç•ªå·ã«+1ã™ã‚‹
                        const cssGridRowStart = parseInt(effectiveGridRowStartId) + 1; 

                        // çµ‚äº†è¡Œã‚‚åŒæ§˜ã«+1ã™ã‚‹ã€‚çµ‚äº†è¡ŒãŒãªã„å ´åˆã¯é–‹å§‹è¡Œ+1ï¼ˆ1è¡Œåˆ†ï¼‰ã¨ã™ã‚‹
                        const cssGridRowEnd = effectiveGridRowEndId ? 
                                                parseInt(effectiveGridRowEndId) + 1 : 
                                                cssGridRowStart + 1;

                        // CSSã‚°ãƒªãƒƒãƒ‰ã®åˆ—ã‚‚ã€ãƒ©ãƒ™ãƒ«åˆ—(1åˆ—ç›®)ãŒã‚ã‚‹ã®ã§+1ã™ã‚‹
                        const cssGridColStart = parseInt(effectiveGridColStart) + 1;
                        
                        // çµ‚äº†åˆ—ã‚‚åŒæ§˜ã«+1ã™ã‚‹ã€‚çµ‚äº†åˆ—ãŒãªã„å ´åˆã¯é–‹å§‹åˆ—+1ï¼ˆ1åˆ—åˆ†ï¼‰ã¨ã™ã‚‹
                        const cssGridColEnd = effectiveGridColEnd ? 
                                            parseInt(effectiveGridColEnd) + 1 : 
                                            cssGridColStart + 1;

                        const subjectBlock = document.createElement('div');
                        subjectBlock.className = 'subject-block';
                        
                        // ç§‘ç›®è©³ç´°ã‹ã‚‰ã‚¿ã‚¤ãƒ—ã‚’å–å¾—ã—ã¦è‰²åˆ†ã‘ã™ã‚‹
                        const subjectDetailedType = (mapPos['ç§‘ç›®è©³ç´°'] || '').split('--')[0]; // ã€Œå¿…ä¿®ç§‘ç›®--ã‚¦ã‚§ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³1ã€ã‹ã‚‰ã€Œå¿…ä¿®ç§‘ç›®ã€ã‚’æŠ½å‡º
                        const typeClass = getSubjectTypeClass(subjectDetailedType);
                        if (typeClass) {
                            subjectBlock.classList.add(typeClass);
                        }
                        
                        subjectBlock.style.gridRow = `${cssGridRowStart} / ${cssGridRowEnd}`;
                        subjectBlock.style.gridColumn = `${cssGridColStart} / ${cssGridColEnd}`;

                        // ç§‘ç›®åã‚‚ã€Œç§‘ç›®è©³ç´°ã€ã‹ã‚‰å–å¾—ã™ã‚‹æ–¹ãŒç¢ºå®Ÿ
                        // const subjectNameParts = (mapPos['ç§‘ç›®è©³ç´°'] || '').split('--');
                        // const displaySubjectName = subjectNameParts.length > 1 ? subjectNameParts.slice(1).join('--') : subject['ç§‘ç›®å'] || 'ä¸æ˜ç§‘ç›®';
                        // âœ… æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
                        let displaySubjectName = '';
                        const subjectNameParts = (mapPos['ç§‘ç›®è©³ç´°'] || '').split('--');

                        // 1. ã¾ãšã€Œç§‘ç›®è©³ç´°ã€ã‹ã‚‰åå‰ã®å–å¾—ã‚’è©¦ã¿ã‚‹
                        // if (subjectNameParts.length > 1 && subjectNameParts[1].trim() !== '') {
                        //     displaySubjectName = subjectNameParts.slice(1).join('--');
                        // } 
                        // 2. å–å¾—ã§ããªã‘ã‚Œã°ã€ã‚‚ã†ä¸€æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åå‰ã‚’æ¢ã™
                        if (subject && subject['ç§‘ç›®å']) {
                            displaySubjectName = subject['ç§‘ç›®å'];
                        } 
                        // 3. ã©ã¡ã‚‰ã«ã‚‚åå‰ãŒãªã‘ã‚Œã°ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                        else {
                            displaySubjectName = 'ï¼ˆåç§°ä¸æ˜ï¼‰';
                        }
                        subjectBlock.innerHTML = `
                            <a href="detail.html?code=${encodeURIComponent(subjectCode)}" target="_blank">
                                ${displaySubjectName}
                                <div class="block-code">${subjectCode}</div>
                            </a>
                        `;
                        mapGridElement.appendChild(subjectBlock);
                    } else {
                        // ä½ç½®æƒ…å ±ãŒä¸å®Œå…¨ãªç§‘ç›®ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã“ã®ãƒ­ã‚°ã¯æ­£å¸¸ãªå ´åˆã§ã‚‚å‡ºã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰
                        // console.log(`æƒ…å ±: ç§‘ç›® ${subjectCode} ã¯é¸æŠã•ã‚ŒãŸãƒ¡ã‚¸ãƒ£ãƒ¼ (${selectedMajor}) ã®ä½ç½®æƒ…å ±ãŒä¸å®Œå…¨ãªãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
                    }
                }

            } catch (error) {
                console.error("Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
            }
        }
                // ãƒ¡ã‚¸ãƒ£ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        selectMapMajorElement.addEventListener('change', (event) => {
            renderCurriculumMap(event.target.value); // é¸æŠã•ã‚ŒãŸãƒ¡ã‚¸ãƒ£ãƒ¼ã§å†æç”»
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å›³ã‚’æç”» (åˆæœŸè¡¨ç¤ºã¯ISãƒ¡ã‚¸ãƒ£ãƒ¼)
        renderCurriculumMap('IS'); 
    </script>
</body>
</html>