<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情報学領域 カリキュラム系統図</title>
        <link rel="stylesheet" href="curriculum_map.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="slide-menu" id="slide-menu">
        <button class="close-button" id="close-button">&times;</button>
        <ul>
            <li><a href="home.html">ホーム</a></li>
            <li><a href="tanikeisan.html">単位取得内訳</a></li>
            <li><a href="index.html">科目検索（曜日・科目名から）</a></li>
            <li><a href="curriculum_map.html">科目検索（カリキュラムから）</a></li>
            <li><a href="tanisimulation.html">予定とシミュレーション</a></li>
        </ul>
    </nav>
    <div class="overlay" id="overlay"></div>
    <div class="header">
        <div class="fusen-2">
            <span class="home-text">情報領域カリキュラム</span>
        </div>

        <div class="header-right">
            <div class="date" id="current-date"></div>
            <button class="menu-button" aria-label="メニューを開く">
                <img src="image/ハンバーガーメニュー.svg" alt="メニューアイコン">
            </button>
        </div>
    </div>
    <div class="container">
        <div class="major-selector">
            <label for="select-map-major">表示メジャーを選択:</label>
            <select id="select-map-major">
                <option value="IS">ISメジャー</option>
                <option value="NC">NCメジャー</option>
                <option value="XD">XDメジャー</option>
            </select>
        </div>

        <div class="map-container">
            <div class="curriculum-map-grid" id="curriculum-map-grid">
                </div>
        </div>

        <div class="loading-message" id="loading">カリキュラムデータを読み込み中...</div>
        <div class="error-message" id="error" style="display: none;"></div>
        
        <a href="index.html" class="back-to-search">← 検索画面に戻る</a>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // Firebaseの設定（Firebase Consoleからコピーした正確なfirebaseConfigオブジェクトをここに貼り付け）
        const firebaseConfig = {
            apiKey: "AIzaSyAMVDs2C7zKjame91CzT3LJkaz9WszBPHU",
            authDomain: "b3app-b0c29.firebaseapp.com",
            databaseURL: "https://b3app-b0c29-default-rtdb.firebaseio.com",
            projectId: "b3app-b0c29",
            storageBucket: "b3app-b0c29.firebasestorage.app",
            messagingSenderId: "1000910332829",
            appId: "1:1000910332829:web:a1bc233e638afed9b90574"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const mapGridElement = document.getElementById('curriculum-map-grid');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const selectMapMajorElement = document.getElementById('select-map-major'); // メジャー選択ドロップダウン

        let allSubjectsData = {}; // /syllabus_subjects からのデータ (スクレイピングした基本情報)
        let allMetaData = {};     // /curriculum_meta からのデータ (汎用タグ情報)
        let allMapPositionsData = {}; // /curriculum_map_positions からのデータ (メジャーごとの位置情報)

        // 科目種類（詳細）に応じたCSSクラスを返すヘルパー関数 (凡例の色分け用)
        function getSubjectTypeClass(type) {
            switch(type) {
                case '必修科目': return 'type-必修科目';
                case '選択必修科目': return 'type-選択必修科目';
                case '選択科目': return 'type-選択科目';
                case 'メジャー共有科目': return 'type-メジャー共有科目';
                case 'ゼミなど': return 'type-ゼミなど';
                default: return '';
            }
        }

        // カリキュラムグリッドを描画する関数
        async function renderCurriculumMap(selectedMajor = 'IS') { // デフォルトはISメジャーを表示
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                // Firebaseから3つのデータソースを並行して読み込む
                const [syllabusSnapshot, metaSnapshot, mapPositionsSnapshot] = await Promise.all([
                    get(ref(database, 'syllabus_subjects')),
                    get(ref(database, 'curriculum_meta')),
                    get(ref(database, 'curriculum_map_positions'))
                ]);
                
                allSubjectsData = syllabusSnapshot.val() || {};
                allMetaData = metaSnapshot.val() || {};         
                allMapPositionsData = mapPositionsSnapshot.val() || {};

                loadingElement.style.display = 'none';
                mapGridElement.innerHTML = ''; // グリッドをクリア

                // グリッドの軸ラベル（列ヘッダー）を生成
                const totalGridColumns = 13; // ★修正: CSVに合わせ13列
                let columnHeaders = [];
                // 列ヘッダーのテキストは、メジャーごとに異なるのでselectedMajorに応じて設定
                // カラムヘッダーの具体的なテキストは、各メジャーの図を見て埋める必要があります
                if (selectedMajor === 'IS') {
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12']; // ISメジャーの列名
                } else if (selectedMajor === 'NC') {
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12']; // NCメジャーの列名
                } else if (selectedMajor === 'XD') {
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12']; // XDメジャーの列名
                } else { // ALLなどの場合、汎用的なヘッダー
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12'];
                }


                // グリッドのCSS行数も定義（rowMapの最大値 + 1 (ヘッダー行)）
                // const maxRowNumber = Math.max(...Object.values(rowMap)) || 1; 
                // mapGridElement.style.gridTemplateRows = `auto repeat(${maxRowNumber}, minmax(30px, auto))`;
                mapGridElement.style.gridTemplateColumns = `80px repeat(12, minmax(100px, 1fr))`; // ラベル列 + 12列 (13列)


                // カラムヘッダー（1行目）
                for (let col = 0; col < totalGridColumns; col++) {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'grid-label grid-column-header';
                    headerCell.style.gridRow = 1; // 1行目
                    headerCell.style.gridColumn = col + 1; // 1列目から開始
                    if (col > 0) { // 最初のセルは空
                        headerCell.textContent = columnHeaders[col];
                    }
                    mapGridElement.appendChild(headerCell);
                }


                // 科目ブロックを配置
                for (const subjectCode in allSubjectsData) {
                    const subject = allSubjectsData[subjectCode]; // 基本情報
                    const meta = allMetaData[subjectCode] || {};   // 汎用タグ情報
                    const mapPos = allMapPositionsData[subjectCode] || {}; // 位置情報

                    let effectiveGridRowStartId = null;
                    let effectiveGridColStart = null;
                    let effectiveGridRowEndId = null;
                    let effectiveGridColEnd = null;
                    
                    // 選択されたメジャーに応じて位置情報を取得
                    // 科目が存在しないメジャーのデータは空欄になっているはず
                    if (selectedMajor === 'IS' && mapPos['IS_row'] !== undefined && mapPos['IS_row'] !== null && mapPos['IS_row'] !== '') {
                        effectiveGridRowStartId = mapPos['IS_row'];
                        effectiveGridColStart = mapPos['IS_col'];
                        effectiveGridRowEndId = mapPos['IS_row_end'];
                        effectiveGridColEnd = mapPos['IS_col_end'];
                    } else if (selectedMajor === 'NC' && mapPos['NC_row'] !== undefined && mapPos['NC_row'] !== null && mapPos['NC_row'] !== '') {
                        effectiveGridRowStartId = mapPos['NC_row'];
                        effectiveGridColStart = mapPos['NC_col'];
                        effectiveGridRowEndId = mapPos['NC_row_end'];
                        effectiveGridColEnd = mapPos['NC_col_end'];
                    } else if (selectedMajor === 'XD' && mapPos['XD_row'] !== undefined && mapPos['XD_row'] !== null && mapPos['XD_row'] !== '') {
                        effectiveGridRowStartId = mapPos['XD_row'];
                        effectiveGridColStart = mapPos['XD_col'];
                        effectiveGridRowEndId = mapPos['XD_row_end'];
                        effectiveGridColEnd = mapPos['XD_col_end'];
                    } else if (selectedMajor === 'ALL') {
                        // ALL選択時は、いずれかのメジャーの位置情報があれば表示
                        if (mapPos['IS_row'] !== undefined && mapPos['IS_row'] !== null && mapPos['IS_row'] !== '') {
                            effectiveGridRowStartId = mapPos['IS_row'];
                            effectiveGridColStart = mapPos['IS_col'];
                            effectiveGridRowEndId = mapPos['IS_row_end'];
                            effectiveGridColEnd = mapPos['IS_col_end'];
                        } else if (mapPos['NC_row'] !== undefined && mapPos['NC_row'] !== null && mapPos['NC_row'] !== '') {
                            effectiveGridRowStartId = mapPos['NC_row'];
                            effectiveGridColStart = mapPos['NC_col'];
                            effectiveGridRowEndId = mapPos['NC_row_end'];
                            effectiveGridColEnd = mapPos['NC_col_end'];
                        } else if (mapPos['XD_row'] !== undefined && mapPos['XD_row'] !== null && mapPos['XD_row'] !== '') {
                            effectiveGridRowStartId = mapPos['XD_row'];
                            effectiveGridColStart = mapPos['XD_col'];
                            effectiveGridRowEndId = mapPos['XD_row_end'];
                            effectiveGridColEnd = mapPos['XD_col_end'];
                        } else {
                            // どのメジャーにも特化しない科目 (汎用位置があれば、もしCSVにあれば)
                            effectiveGridRowStartId = mapPos['grid_row_start'];
                            effectiveGridColStart = mapPos['grid_column_start'];
                            effectiveGridRowEndId = mapPos['grid_row_end'];
                            effectiveGridColEnd = mapPos['grid_column_end'];
                        }
                    } else {
                        // 選択されたメジャー用の位置情報がない、かつALLでもない場合、この科目は表示しない
                        console.log(`情報: 科目 ${subjectCode} は選択されたメジャー (${selectedMajor}) のカリキュラム図上での位置情報がないため表示をスキップしました。`);
                        continue;
                    }
                    
                    const subjectDetailedType = mapPos['科目詳細'] || ''; // CSVの「科目詳細」列を凡例の色分けに使う

                    // 位置情報が揃っている科目のみ描画
                    if (effectiveGridRowStartId && effectiveGridColStart) { 
                        // CSSグリッドの行はヘッダー行(1行目)があるので、CSVの行番号に+1する
                        const cssGridRowStart = parseInt(effectiveGridRowStartId) + 1; 

                        // 終了行も同様に+1する。終了行がない場合は開始行+1（1行分）とする
                        const cssGridRowEnd = effectiveGridRowEndId ? 
                                                parseInt(effectiveGridRowEndId) + 1 : 
                                                cssGridRowStart + 1;

                        // CSSグリッドの列も、ラベル列(1列目)があるので+1する
                        const cssGridColStart = parseInt(effectiveGridColStart) + 1;
                        
                        // 終了列も同様に+1する。終了列がない場合は開始列+1（1列分）とする
                        const cssGridColEnd = effectiveGridColEnd ? 
                                            parseInt(effectiveGridColEnd) + 1 : 
                                            cssGridColStart + 1;

                        const subjectBlock = document.createElement('div');
                        subjectBlock.className = 'subject-block';
                        
                        // 科目詳細からタイプを取得して色分けする
                        const subjectDetailedType = (mapPos['科目詳細'] || '').split('--')[0]; // 「必修科目--ウェブデザイン1」から「必修科目」を抽出
                        const typeClass = getSubjectTypeClass(subjectDetailedType);
                        if (typeClass) {
                            subjectBlock.classList.add(typeClass);
                        }
                        
                        subjectBlock.style.gridRow = `${cssGridRowStart} / ${cssGridRowEnd}`;
                        subjectBlock.style.gridColumn = `${cssGridColStart} / ${cssGridColEnd}`;

                        let displaySubjectName = '';
                        const subjectNameParts = (mapPos['科目詳細'] || '').split('--');

                        if (subject && subject['科目名']) {
                            displaySubjectName = subject['科目名'].split('／')[0].trim();
                        } 
                        // 3. どちらにも名前がなければ、プレースホルダーを表示
                        else {
                            displaySubjectName = '（名称不明）';
                        }
                        subjectBlock.innerHTML = `
                            <a href="detail.html?code=${encodeURIComponent(subjectCode)}" target="_blank">
                                ${displaySubjectName}
                            </a>
                        `;
                        mapGridElement.appendChild(subjectBlock);
                    } else {
                        // 位置情報が不完全な科目はスキップ（このログは正常な場合でも出ることがあります）
                        // console.log(`情報: 科目 ${subjectCode} は選択されたメジャー (${selectedMajor}) の位置情報が不完全なためスキップ`);
                    }
                }

            } catch (error) {
                console.error("Firebaseからのデータ取得エラー:", error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `カリキュラムデータの読み込みに失敗しました: ${error.message}`;
            }
        }
                // メジャー選択ドロップダウンのイベントリスナー
        selectMapMajorElement.addEventListener('change', (event) => {
            renderCurriculumMap(event.target.value); // 選択されたメジャーで再描画
        });

        // ページ読み込み時にカリキュラム図を描画 (初期表示はISメジャー)
        renderCurriculumMap('IS'); 
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateElement.textContent = `${year}/${month}/${day}`;
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuButton = document.querySelector('.menu-button');
            const slideMenu = document.getElementById('slide-menu');
            const overlay = document.getElementById('overlay');
            const closeButton = document.getElementById('close-button');

            // メニューを開く
            menuButton.addEventListener('click', () => {
                slideMenu.classList.add('open');
                overlay.classList.add('active');
            });

            // メニューを閉じる（閉じるボタン）
            closeButton.addEventListener('click', () => {
                slideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });

            // メニューを閉じる（オーバーレイ）
            overlay.addEventListener('click', () => {
                slideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });
        });
    </script>

</body>
</html>