<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情報学領域 カリキュラム系統図</title>
    <style>
        /* 基本スタイル */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; /* 変更点: bodyのmarginを0に */
            padding: 20px; /* 変更点: 代わりにpaddingを設定 */
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            box-sizing: border-box; /* 変更点 */
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .map-container {
            max-width: 1400px;
            width: 100%; /* 変更点: 常に親要素の幅に合わせる */
            box-sizing: border-box; /* 変更点: paddingを幅計算に含める */
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* メジャー選択UI */
        .major-selector {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e6f7ff;
            border-radius: 5px;
            border: 1px solid #cceeff;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .major-selector label {
            font-weight: bold;
            margin-right: 10px;
            color: #0056b3;
        }
        .major-selector select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #007bff;
            font-size: 1em;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%20197.8L145.2%2048.7%203.2%20197.8c-4.6%204.6-12%204.6-16.6%200l-16.6-16.6c-4.6-4.6-4.6-12%200-16.6l155.4-155.4c4.6-4.6%2012-4.6%2016.6%200l155.4%20155.4c4.6%204.6%204.6%2012%200%2016.6l-16.6%2016.6c-4.6%204.7-12%204.7-16.6.1z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 0.65em auto;
            padding-right: 2.5em;
        }


        /* CSS Grid 定義 */
        .curriculum-map-grid {
            display: grid;
            grid-template-columns: 80px repeat(13, minmax(100px, 1fr)); /* 列定義は維持 */
            grid-template-rows: auto repeat(20, minmax(30px, auto));
            gap: 5px;
            padding: 10px;
            border: 1px solid #ccc;
            /* min-width: 1400px; */ /* 🗑️ 変更点: この行を削除またはコメントアウト */
            overflow-x: auto; /* 変更点: はみ出た場合はグリッド内を横スクロール */
        }

        /* グリッドの軸ラベルスタイル */
        .grid-label {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #666;
            border: 1px solid #eee;
            background-color: #f8f8f8;
            font-size: 0.9em;
            overflow: hidden;
            white-space: nowrap;
        }
        .grid-label.grid-column-header {
            background-color: #e9e9e9;
            font-size: 0.95em;
            padding: 5px;
            border-bottom: 2px solid #ccc;
        }
        .grid-label.semester-num-label {
            background-color: #e2e2e2;
            font-size: 1em;
            color: #333;
            border-right: 1px solid #bbb;
            border-bottom: 1px solid #eee;
            padding: 5px;
            white-space: pre-wrap;
            line-height: 1.2;
        }
        .grid-label.quarter-label {
            background-color: #f8f8f8;
            font-size: 0.85em;
            color: #666;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        /* 科目ブロックのスタイル */
        .subject-block {
            background-color: #e0f7fa;
            border: 1px solid #a7d9e7;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px 10px;
            text-align: center;
            /* ✨ 変更点: 文字サイズを可変に */
            font-size: clamp(0.7em, 1.5vw, 0.9em);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-height: 40px; /* 変更点: 小さくなりすぎないように最小の高さを設定 */
        }
        .subject-block:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .subject-block a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .subject-block a:hover {
            color: #0056b3;
        }
        .subject-block .block-code {
            font-size: 0.8em; /* 変更点: 親要素に対する相対的なサイズに */
            color: #666;
            margin-top: 3px;
        }

        /* 科目種類に応じた色分け */
        .type-必修科目 { background-color: #ffcdd2; border-color: #ef9a9a; }
        .type-選択必修科目 { background-color: #ffe0b2; border-color: #ffcc80; }
        .type-選択科目 { background-color: #c8e6c9; border-color: #a5d6a7; }
        .type-メジャー共有科目 { background-color: #bbdefb; border-color: #90caf9; }
        .type-ゼミなど { background-color: #e1bee7; border-color: #ce93d8; }
        .type-教養 { background-color: #d8e2dc; border-color: #a3b9b4; } 
        .type-工学基礎 { background-color: #d0f0c0; border-color: #90c280; }
        .type-情報基礎 { background-color: #c0d9e8; border-color: #8cb8cc; }
        .type-情報応用 { background-color: #e6e6fa; color: #6a5acd; border-color: #a7a7ff; }

        /* メッセージ表示 */
        .loading-message, .error-message {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: #6c757d;
        }
        .error-message {
            color: #dc3545;
        }
        .back-to-search {
            display: block;
            text-align: center;
            margin-top: 20px;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        .back-to-search:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>情報学領域 カリキュラム系統図</h1>

    <div class="major-selector">
        <label for="select-map-major">表示メジャーを選択:</label>
        <select id="select-map-major">
            <option value="IS">ISメジャー</option>
            <option value="NC">NCメジャー</option>
            <option value="XD">XDメジャー</option>
            <option value="ALL">すべて表示 (実験的)</option> </select>
    </div>

    <div class="map-container">
        <div class="curriculum-map-grid" id="curriculum-map-grid">
            </div>
    </div>

    <div class="loading-message" id="loading">カリキュラムデータを読み込み中...</div>
    <div class="error-message" id="error" style="display: none;"></div>
    
    <a href="index.html" class="back-to-search">← 検索画面に戻る</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // Firebaseの設定（Firebase Consoleからコピーした正確なfirebaseConfigオブジェクトをここに貼り付け）
        const firebaseConfig = {
            apiKey: "AIzaSyAMVDs2C7zKjame91CzT3LJkaz9WszBPHU",
            authDomain: "b3app-b0c29.firebaseapp.com",
            databaseURL: "https://b3app-b0c29-default-rtdb.firebaseio.com",
            projectId: "b3app-b0c29",
            storageBucket: "b3app-b0c29.firebasestorage.app",
            messagingSenderId: "1000910332829",
            appId: "1:1000910332829:web:a1bc233e638afed9b90574"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const mapGridElement = document.getElementById('curriculum-map-grid');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const selectMapMajorElement = document.getElementById('select-map-major'); // メジャー選択ドロップダウン

        let allSubjectsData = {}; // /syllabus_subjects からのデータ (スクレイピングした基本情報)
        let allMetaData = {};     // /curriculum_meta からのデータ (汎用タグ情報)
        let allMapPositionsData = {}; // /curriculum_map_positions からのデータ (メジャーごとの位置情報)

        // // ★修正: グリッドの行のマッピングを定義（あなたの指示に厳密に従い定義）
        // const rowMap = {
        //     '3セメ1Q': 1, // 3セメスタ1Qが1行目から
        //     '3セメ2Q': 2, // 3セメスタ2Qが2行目から
        //     '4セメ3Q': 3, // 4セメスタ3Qが3行目から
        //     '4セメ4Q': 4, // 4セメスタ4Qが4行目から
        //     '5セメ1Q': 5, // 5セメスタ1Qが5行目から
        //     '5セメ2Q': 6, // 5セメスタ2Qが6行目から
        //     '6セメ3Q': 7, // 6セメスタ3Qが7行目から
        //     '6セメ4Q': 8, // 6セメスタ4Qが8行目から

        // };

        // 科目種類（詳細）に応じたCSSクラスを返すヘルパー関数 (凡例の色分け用)
        function getSubjectTypeClass(type) {
            switch(type) {
                case '必修科目': return 'type-必修科目';
                case '選択必修科目': return 'type-選択必修科目';
                case '選択科目': return 'type-選択科目';
                case 'メジャー共有科目': return 'type-メジャー共有科目';
                case 'ゼミなど': return 'type-ゼミなど';
                default: return '';
            }
        }

        // カリキュラムグリッドを描画する関数
        async function renderCurriculumMap(selectedMajor = 'IS') { // デフォルトはISメジャーを表示
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                // Firebaseから3つのデータソースを並行して読み込む
                const [syllabusSnapshot, metaSnapshot, mapPositionsSnapshot] = await Promise.all([
                    get(ref(database, 'syllabus_subjects')),
                    get(ref(database, 'curriculum_meta')),
                    get(ref(database, 'curriculum_map_positions'))
                ]);
                
                allSubjectsData = syllabusSnapshot.val() || {};
                allMetaData = metaSnapshot.val() || {};         
                allMapPositionsData = mapPositionsSnapshot.val() || {};

                loadingElement.style.display = 'none';
                mapGridElement.innerHTML = ''; // グリッドをクリア

                // グリッドの軸ラベル（列ヘッダー）を生成
                const totalGridColumns = 13; // ★修正: CSVに合わせ13列
                let columnHeaders = [];
                // 列ヘッダーのテキストは、メジャーごとに異なるのでselectedMajorに応じて設定
                // カラムヘッダーの具体的なテキストは、各メジャーの図を見て埋める必要があります
                if (selectedMajor === 'IS') {
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12']; // ISメジャーの列名
                } else if (selectedMajor === 'NC') {
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12']; // NCメジャーの列名
                } else if (selectedMajor === 'XD') {
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12']; // XDメジャーの列名
                } else { // ALLなどの場合、汎用的なヘッダー
                    columnHeaders = ['', '列1', '列2', '列3', '列4', '列5', '列6', '列7', '列8', '列9', '列10', '列11', '列12'];
                }


                // グリッドのCSS行数も定義（rowMapの最大値 + 1 (ヘッダー行)）
                // const maxRowNumber = Math.max(...Object.values(rowMap)) || 1; 
                // mapGridElement.style.gridTemplateRows = `auto repeat(${maxRowNumber}, minmax(30px, auto))`;
                mapGridElement.style.gridTemplateColumns = `80px repeat(12, minmax(100px, 1fr))`; // ラベル列 + 12列 (13列)


                // カラムヘッダー（1行目）
                for (let col = 0; col < totalGridColumns; col++) {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'grid-label grid-column-header';
                    headerCell.style.gridRow = 1; // 1行目
                    headerCell.style.gridColumn = col + 1; // 1列目から開始
                    if (col > 0) { // 最初のセルは空
                        headerCell.textContent = columnHeaders[col];
                    }
                    mapGridElement.appendChild(headerCell);
                }


                // 科目ブロックを配置
                for (const subjectCode in allSubjectsData) {
                    const subject = allSubjectsData[subjectCode]; // 基本情報
                    const meta = allMetaData[subjectCode] || {};   // 汎用タグ情報
                    const mapPos = allMapPositionsData[subjectCode] || {}; // 位置情報

                    let effectiveGridRowStartId = null;
                    let effectiveGridColStart = null;
                    let effectiveGridRowEndId = null;
                    let effectiveGridColEnd = null;
                    
                    // 選択されたメジャーに応じて位置情報を取得
                    // 科目が存在しないメジャーのデータは空欄になっているはず
                    if (selectedMajor === 'IS' && mapPos['IS_row'] !== undefined && mapPos['IS_row'] !== null && mapPos['IS_row'] !== '') {
                        effectiveGridRowStartId = mapPos['IS_row'];
                        effectiveGridColStart = mapPos['IS_col'];
                        effectiveGridRowEndId = mapPos['IS_row_end'];
                        effectiveGridColEnd = mapPos['IS_col_end'];
                    } else if (selectedMajor === 'NC' && mapPos['NC_row'] !== undefined && mapPos['NC_row'] !== null && mapPos['NC_row'] !== '') {
                        effectiveGridRowStartId = mapPos['NC_row'];
                        effectiveGridColStart = mapPos['NC_col'];
                        effectiveGridRowEndId = mapPos['NC_row_end'];
                        effectiveGridColEnd = mapPos['NC_col_end'];
                    } else if (selectedMajor === 'XD' && mapPos['XD_row'] !== undefined && mapPos['XD_row'] !== null && mapPos['XD_row'] !== '') {
                        effectiveGridRowStartId = mapPos['XD_row'];
                        effectiveGridColStart = mapPos['XD_col'];
                        effectiveGridRowEndId = mapPos['XD_row_end'];
                        effectiveGridColEnd = mapPos['XD_col_end'];
                    } else if (selectedMajor === 'ALL') {
                        // ALL選択時は、いずれかのメジャーの位置情報があれば表示
                        if (mapPos['IS_row'] !== undefined && mapPos['IS_row'] !== null && mapPos['IS_row'] !== '') {
                            effectiveGridRowStartId = mapPos['IS_row'];
                            effectiveGridColStart = mapPos['IS_col'];
                            effectiveGridRowEndId = mapPos['IS_row_end'];
                            effectiveGridColEnd = mapPos['IS_col_end'];
                        } else if (mapPos['NC_row'] !== undefined && mapPos['NC_row'] !== null && mapPos['NC_row'] !== '') {
                            effectiveGridRowStartId = mapPos['NC_row'];
                            effectiveGridColStart = mapPos['NC_col'];
                            effectiveGridRowEndId = mapPos['NC_row_end'];
                            effectiveGridColEnd = mapPos['NC_col_end'];
                        } else if (mapPos['XD_row'] !== undefined && mapPos['XD_row'] !== null && mapPos['XD_row'] !== '') {
                            effectiveGridRowStartId = mapPos['XD_row'];
                            effectiveGridColStart = mapPos['XD_col'];
                            effectiveGridRowEndId = mapPos['XD_row_end'];
                            effectiveGridColEnd = mapPos['XD_col_end'];
                        } else {
                            // どのメジャーにも特化しない科目 (汎用位置があれば、もしCSVにあれば)
                            effectiveGridRowStartId = mapPos['grid_row_start'];
                            effectiveGridColStart = mapPos['grid_column_start'];
                            effectiveGridRowEndId = mapPos['grid_row_end'];
                            effectiveGridColEnd = mapPos['grid_column_end'];
                        }
                    } else {
                        // 選択されたメジャー用の位置情報がない、かつALLでもない場合、この科目は表示しない
                        console.log(`情報: 科目 ${subjectCode} は選択されたメジャー (${selectedMajor}) のカリキュラム図上での位置情報がないため表示をスキップしました。`);
                        continue;
                    }
                    
                    const subjectDetailedType = mapPos['科目詳細'] || ''; // CSVの「科目詳細」列を凡例の色分けに使う

                    // 位置情報が揃っている科目のみ描画
                    if (effectiveGridRowStartId && effectiveGridColStart) { 
                        // CSSグリッドの行はヘッダー行(1行目)があるので、CSVの行番号に+1する
                        const cssGridRowStart = parseInt(effectiveGridRowStartId) + 1; 

                        // 終了行も同様に+1する。終了行がない場合は開始行+1（1行分）とする
                        const cssGridRowEnd = effectiveGridRowEndId ? 
                                                parseInt(effectiveGridRowEndId) + 1 : 
                                                cssGridRowStart + 1;

                        // CSSグリッドの列も、ラベル列(1列目)があるので+1する
                        const cssGridColStart = parseInt(effectiveGridColStart) + 1;
                        
                        // 終了列も同様に+1する。終了列がない場合は開始列+1（1列分）とする
                        const cssGridColEnd = effectiveGridColEnd ? 
                                            parseInt(effectiveGridColEnd) + 1 : 
                                            cssGridColStart + 1;

                        const subjectBlock = document.createElement('div');
                        subjectBlock.className = 'subject-block';
                        
                        // 科目詳細からタイプを取得して色分けする
                        const subjectDetailedType = (mapPos['科目詳細'] || '').split('--')[0]; // 「必修科目--ウェブデザイン1」から「必修科目」を抽出
                        const typeClass = getSubjectTypeClass(subjectDetailedType);
                        if (typeClass) {
                            subjectBlock.classList.add(typeClass);
                        }
                        
                        subjectBlock.style.gridRow = `${cssGridRowStart} / ${cssGridRowEnd}`;
                        subjectBlock.style.gridColumn = `${cssGridColStart} / ${cssGridColEnd}`;

                        // 科目名も「科目詳細」から取得する方が確実
                        // const subjectNameParts = (mapPos['科目詳細'] || '').split('--');
                        // const displaySubjectName = subjectNameParts.length > 1 ? subjectNameParts.slice(1).join('--') : subject['科目名'] || '不明科目';
                        // ✅ 新しいコードブロック
                        let displaySubjectName = '';
                        const subjectNameParts = (mapPos['科目詳細'] || '').split('--');

                        // 1. まず「科目詳細」から名前の取得を試みる
                        // if (subjectNameParts.length > 1 && subjectNameParts[1].trim() !== '') {
                        //     displaySubjectName = subjectNameParts.slice(1).join('--');
                        // } 
                        // 2. 取得できなければ、もう一方のデータから名前を探す
                        if (subject && subject['科目名']) {
                            displaySubjectName = subject['科目名'];
                        } 
                        // 3. どちらにも名前がなければ、プレースホルダーを表示
                        else {
                            displaySubjectName = '（名称不明）';
                        }
                        subjectBlock.innerHTML = `
                            <a href="detail.html?code=${encodeURIComponent(subjectCode)}" target="_blank">
                                ${displaySubjectName}
                                <div class="block-code">${subjectCode}</div>
                            </a>
                        `;
                        mapGridElement.appendChild(subjectBlock);
                    } else {
                        // 位置情報が不完全な科目はスキップ（このログは正常な場合でも出ることがあります）
                        // console.log(`情報: 科目 ${subjectCode} は選択されたメジャー (${selectedMajor}) の位置情報が不完全なためスキップ`);
                    }
                }

            } catch (error) {
                console.error("Firebaseからのデータ取得エラー:", error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `カリキュラムデータの読み込みに失敗しました: ${error.message}`;
            }
        }
                // メジャー選択ドロップダウンのイベントリスナー
        selectMapMajorElement.addEventListener('change', (event) => {
            renderCurriculumMap(event.target.value); // 選択されたメジャーで再描画
        });

        // ページ読み込み時にカリキュラム図を描画 (初期表示はISメジャー)
        renderCurriculumMap('IS'); 
    </script>
</body>
</html>