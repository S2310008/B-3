<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’Œæ­Œå±±å¤§å­¦ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ æ¤œç´¢</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="fusen-2">
            <span class="home-text">ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ æ¤œç´¢</span>
        </div>
        <div class="date" id="current-date"></div>
    </div>

    <div class="search-container">
        <div class="search-tabs">
            <button id="time-search-tab" class="search-tab-button active">æ™‚é–“å¸¯æ¤œç´¢</button>
            <button id="name-search-tab" class="search-tab-button">ç§‘ç›®åæ¤œç´¢</button>
        </div>

        <div id="time-search-panel">
            <div class="search-input-group">
                <select id="select-period-filter">
                    <option value="å…¨ã¦">é–‹è¬›æœŸé–“ (å…¨ã¦)</option>
                    <option value="å‰æœŸ">å‰æœŸ</option>
                    <option value="å¾ŒæœŸ">å¾ŒæœŸ</option>
                    <option value="é€šå¹´">é€šå¹´</option>
                </select>
                <select id="select-day-filter">
                    <option value="å…¨ã¦">æ›œæ—¥ (å…¨ã¦)</option>
                    <option value="æœˆ">æœˆæ›œæ—¥</option>
                    <option value="ç«">ç«æ›œæ—¥</option>
                    <option value="æ°´">æ°´æ›œæ—¥</option>
                    <option value="æœ¨">æœ¨æ›œæ—¥</option>
                    <option value="é‡‘">é‡‘æ›œæ—¥</option>
                </select>
                <select id="select-time-filter">
                    <option value="å…¨ã¦">æ™‚é–“ (å…¨ã¦)</option>
                    <option value="1">1æ™‚é™</option>
                    <option value="2">2æ™‚é™</option>
                    <option value="3">3æ™‚é™</option>
                    <option value="4">4æ™‚é™</option>
                    <option value="5">5æ™‚é™</option>
                    <option value="6">6æ™‚é™</option>
                </select>
                <button id="search-button">ğŸ”æ¤œç´¢</button>
            </div>
        </div>

        <div id="name-search-panel" style="display: none;">
            <div class="search-input-group">
                <input type="text" id="subject-name-input" placeholder="ç§‘ç›®åã‚’å…¥åŠ›">
                <button id="name-search-button">ğŸ”æ¤œç´¢</button>
            </div>
        </div>
    </div>

    <div class="loading-message" id="loading">ç§‘ç›®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="error-message" id="error" style="display: none;"></div>
    <ul id="search-results" class="search-results-list"></ul>
    <div class="no-results-message" id="no-results" style="display: none;">è©²å½“ã™ã‚‹ç§‘ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // (ä¸­ç•¥) Firebaseã¨æ¤œç´¢æ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—
        const firebaseConfig = {
            apiKey: "AIzaSyAMVDs2C7zKjame91CzT3LJkaz9WszBPHU",
            authDomain: "b3app-b0c29.firebaseapp.com",
            databaseURL: "https://b3app-b0c29-default-rtdb.firebaseio.com",
            projectId: "b3app-b0c29",
            storageBucket: "b3app-b0c29.appspot.com",
            messagingSenderId: "1000910332829",
            appId: "1:1000910332829:web:a1bc233e638afed9b90574"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const searchResultsList = document.getElementById('search-results');
        const noResultsElement = document.getElementById('no-results');
        const timeSearchTab = document.getElementById('time-search-tab');
        const nameSearchTab = document.getElementById('name-search-tab');
        const timeSearchPanel = document.getElementById('time-search-panel');
        const nameSearchPanel = document.getElementById('name-search-panel');
        const selectPeriodFilter = document.getElementById('select-period-filter');
        const selectDayFilter = document.getElementById('select-day-filter');
        const selectTimeFilter = document.getElementById('select-time-filter');
        const searchButton = document.getElementById('search-button');
        const subjectNameInput = document.getElementById('subject-name-input');
        const nameSearchButton = document.getElementById('name-search-button');
        let allSubjectsData = {};
        function mapOfferingDivision(division) {
            if (!division) return 'ä¸æ˜';
            if (division.includes('ç¬¬1ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('ç¬¬2ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('å‰æœŸ')) return 'å‰æœŸ';
            if (division.includes('ç¬¬3ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('ç¬¬4ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('å¾ŒæœŸ')) return 'å¾ŒæœŸ';
            if (division.includes('é€šå¹´')) return 'é€šå¹´';
            return 'ãã®ä»–';
        }
        function displayResults(subjectsToDisplay) {
            searchResultsList.innerHTML = '';
            noResultsElement.style.display = 'none';
            if (Object.keys(subjectsToDisplay).length === 0) {
                noResultsElement.style.display = 'block';
                return;
            }
            for (const subjectCode in subjectsToDisplay) {
                const subject = subjectsToDisplay[subjectCode];
                const listItem = document.createElement('li');
                let tagsHtml = '';
                const tagSpans = [];
                if (subject.tag4) tagSpans.push(`<span class="subject-tag tag-special-4">${subject.tag4}</span>`);
                if (subject.tag1) tagSpans.push(`<span class="subject-tag">${subject.tag1}</span>`);
                if (subject.tag2) tagSpans.push(`<span class="subject-tag">${subject.tag2}</span>`);
                if (subject.tag3) tagSpans.push(`<span class="subject-tag">${subject.tag3}</span>`);
                if (tagSpans.length > 0) tagsHtml = `<div style="margin-top:5px;">${tagSpans.join(' ')}</div>`;
                const term = subject['é–‹è¬›åŒºåˆ†'] ? subject['é–‹è¬›åŒºåˆ†'].split('ï¼')[0] : 'é–‹è¬›åŒºåˆ†ä¸æ˜';
                listItem.innerHTML = `<a href="detail.html?code=${encodeURIComponent(subjectCode)}" target="_blank">${subject['ç§‘ç›®å'] ?? 'ä¸æ˜ãªç§‘ç›®'}<div class="result-details">${subject['æ•™å“¡å'] ?? 'æ•™å“¡ä¸æ˜'} | ${subject['æ›œé™'] ?? 'æ›œé™ä¸æ˜'} | ${term} | ${subject['å˜ä½æ•°'] ?? '?'}å˜ä½${tagsHtml}</div></a>`;
                searchResultsList.appendChild(listItem);
            }
        }
        function filterAndDisplayTimeSearch(periodFilter, dayFilter, timeFilter) {
            let filtered = {};
            for (const subjectCode in allSubjectsData) {
                const subject = allSubjectsData[subjectCode];
                const subjectPeriod = mapOfferingDivision(subject['é–‹è¬›åŒºåˆ†']);
                if (periodFilter !== 'å…¨ã¦' && subjectPeriod !== periodFilter) continue;
                let timeSlotMatches = false;
                if (dayFilter === 'å…¨ã¦' && timeFilter === 'å…¨ã¦') {
                    timeSlotMatches = true;
                } else if (subject['æ›œé™']) {
                    const timeSlots = subject['æ›œé™'].split(',');
                    for (const slot of timeSlots) {
                        const match = slot.match(/([æœˆç«æ°´æœ¨é‡‘])\S*\s*(\d+)/);
                        if (match) {
                            const dayChar = match[1];
                            const timePart = match[2];
                            const dayMatches = (dayFilter === 'å…¨ã¦' || dayChar === dayFilter);
                            const timeMatches = (timeFilter === 'å…¨ã¦' || timePart === timeFilter);
                            if (dayMatches && timeMatches) {
                                timeSlotMatches = true;
                                break;
                            }
                        }
                    }
                }
                if (timeSlotMatches) filtered[subjectCode] = subject;
            }
            displayResults(filtered);
        }
        function filterAndDisplayNameSearch(nameInput) {
            const lowerCaseInput = nameInput.toLowerCase().trim();
            if (!lowerCaseInput) {
                applyCurrentSearchFilter();
                return;
            }
            let filtered = {};
            for (const subjectCode in allSubjectsData) {
                const subject = allSubjectsData[subjectCode];
                const subjectName = (subject['ç§‘ç›®å'] ?? '').toLowerCase();
                if (subjectName.includes(lowerCaseInput)) filtered[subjectCode] = subject;
            }
            displayResults(filtered);
        }
        function applyCurrentSearchFilter() {
            if (timeSearchTab.classList.contains('active')) {
                filterAndDisplayTimeSearch(selectPeriodFilter.value, selectDayFilter.value, selectTimeFilter.value);
            } else if (nameSearchTab.classList.contains('active')) {
                filterAndDisplayNameSearch(subjectNameInput.value);
            }
        }
        async function fetchSubjects() {
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            try {
                const [syllabusSnapshot, metaSnapshot] = await Promise.all([get(ref(database, 'syllabus_subjects')), get(ref(database, 'curriculum_meta'))]);
                const syllabusData = syllabusSnapshot.val() || {};
                const metaData = metaSnapshot.val() || {};
                allSubjectsData = {};
                for (const code in syllabusData) {
                    allSubjectsData[code] = { ...syllabusData[code], ...(metaData[code] || {}) };
                }
                loadingElement.style.display = 'none';
                applyCurrentSearchFilter();
            } catch (error) {
                console.error("Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `ç§‘ç›®æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
            }
        }
        timeSearchTab.addEventListener('click', () => {
            timeSearchTab.classList.add('active');
            nameSearchTab.classList.remove('active');
            timeSearchPanel.style.display = 'block';
            nameSearchPanel.style.display = 'none';
            applyCurrentSearchFilter();
        });
        nameSearchTab.addEventListener('click', () => {
            nameSearchTab.classList.add('active');
            timeSearchTab.classList.remove('active');
            nameSearchPanel.style.display = 'block';
            timeSearchPanel.style.display = 'none';
            applyCurrentSearchFilter();
        });
        searchButton.addEventListener('click', applyCurrentSearchFilter);
        nameSearchButton.addEventListener('click', applyCurrentSearchFilter);
        selectPeriodFilter.addEventListener('change', applyCurrentSearchFilter);
        selectDayFilter.addEventListener('change', applyCurrentSearchFilter);
        selectTimeFilter.addEventListener('change', applyCurrentSearchFilter);
        subjectNameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') applyCurrentSearchFilter();
        });
        fetchSubjects();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateElement.textContent = `${year}/${month}/${day}`;
        });
    </script>
</body>
</html>