<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’Œæ­Œå±±å¤§å­¦ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ æ¤œç´¢</title>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 2.2em;
        }

        /* æ¤œç´¢ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
        .search-container {
            max-width: 800px; /* å°‘ã—åºƒã’ã¦UIã‚’åã‚ã‚‹ */
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .search-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .search-tab-button {
            flex-grow: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .search-tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: bold;
        }

        /* æ¤œç´¢å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .search-input-group {
            display: flex;
            flex-wrap: wrap; /* å°ã•ã„ç”»é¢ã§æŠ˜ã‚Šè¿”ã™ */
            gap: 10px; /* è¦ç´ é–“ã®éš™é–“ */
            align-items: center;
            padding: 10px 0;
        }
        .search-input-group input,
        .search-input-group select {
            border: 1px solid #ced4da; /* æ ç·šã‚’è¿½åŠ  */
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 1em;
            flex-grow: 1;
            outline: none;
            min-width: 120px; /* æœ€å°å¹… */
        }
        .search-input-group select {
            background-color: white;
            cursor: pointer;
            appearance: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŸ¢å°ã‚’æ¶ˆã™ */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%20197.8L145.2%2048.7%203.2%20197.8c-4.6%204.6-12%204.6-16.6%200l-16.6-16.6c-4.6-4.6-4.6-12%200-16.6l155.4-155.4c4.6-4.6%2012-4.6%2016.6%200l155.4%20155.4c4.6%204.6%204.6%2012%200%2016.6l-16.6%2016.6c-4.6%204.7-12%204.7-16.6.1z%22%2F%3E%3C%2Fsvg%3E'); /* ã‚«ã‚¹ã‚¿ãƒ çŸ¢å°ã®è‰²ã‚’åˆã‚ã›ã‚‹ */
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 0.65em auto;
            padding-right: 2.5em; /* çŸ¢å°ã¨ã®éš™é–“ */
        }
        .search-input-group button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—é˜²æ­¢ */
        }
        .search-input-group button:hover {
            background-color: #0056b3;
        }

        /* æ¤œç´¢çµæœãƒªã‚¹ãƒˆ */
        .search-results-list {
            list-style: none;
            padding: 0;
            max-width: 800px;
            margin: 20px auto;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .search-results-list li {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        .search-results-list li:last-child {
            border-bottom: none;
        }
        .search-results-list li a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            display: block;
        }
        .search-results-list li a:hover {
            color: #007bff;
        }
        .search-results-list li .result-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
        .loading-message, .error-message, .no-results-message {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: #6c757d;
        }
        .error-message {
            color: #dc3545;
        }

        /* ã‚¿ã‚°ã‚¹ã‚¿ã‚¤ãƒ« */
        .subject-tag {
            background-color: #f0f0f0;
            color: #555;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-right: 5px;
            display: inline-block;
            white-space: nowrap;
            border: 1px solid #ddd;
            margin-top: 5px;
        }
        .tag-xd { background-color: #e0f2f1; color: #00897b; border-color: #b2dfdb; }

    </style>
</head>
<body>
    <h1>å’Œæ­Œå±±å¤§å­¦ ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ æ¤œç´¢</h1>

    <div class="search-container">
        <div class="search-tabs">
            <button id="time-search-tab" class="search-tab-button active">æ™‚é–“å¸¯æ¤œç´¢</button>
            <button id="name-search-tab" class="search-tab-button">ç§‘ç›®åæ¤œç´¢</button>
        </div>

        <div id="time-search-panel">
            <div class="search-input-group">
                <select id="select-period-filter">
                    <option value="å…¨ã¦">é–‹è¬›æœŸé–“ (å…¨ã¦)</option>
                    <option value="å‰æœŸ">å‰æœŸ</option>
                    <option value="å¾ŒæœŸ">å¾ŒæœŸ</option>
                    <option value="é€šå¹´">é€šå¹´</option>
                </select>
                <select id="select-day-filter">
                    <option value="å…¨ã¦">æ›œæ—¥ (å…¨ã¦)</option>
                    <option value="æœˆ">æœˆæ›œæ—¥</option>
                    <option value="ç«">ç«æ›œæ—¥</option>
                    <option value="æ°´">æ°´æ›œæ—¥</option>
                    <option value="æœ¨">æœ¨æ›œæ—¥</option>
                    <option value="é‡‘">é‡‘æ›œæ—¥</option>
                </select>
                <select id="select-time-filter">
                    <option value="å…¨ã¦">æ™‚é–“ (å…¨ã¦)</option>
                    <option value="1">1æ™‚é™</option>
                    <option value="2">2æ™‚é™</option>
                    <option value="3">3æ™‚é™</option>
                    <option value="4">4æ™‚é™</option>
                    <option value="5">5æ™‚é™</option>
                    <option value="6">6æ™‚é™</option> </select>
                <button id="search-button">ğŸ”æ¤œç´¢</button>
            </div>
        </div>

        <div id="name-search-panel" style="display: none;">
            <div class="search-input-group">
                <input type="text" id="subject-name-input" placeholder="ç§‘ç›®åã‚’å…¥åŠ›">
                <button id="name-search-button">ğŸ”æ¤œç´¢</button>
            </div>
        </div>
    </div>

    <div class="loading-message" id="loading">ç§‘ç›®æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="error-message" id="error" style="display: none;"></div>
    <ul id="search-results" class="search-results-list"></ul>
    <div class="no-results-message" id="no-results" style="display: none;">è©²å½“ã™ã‚‹ç§‘ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAMVDs2C7zKjame91CzT3LJkaz9WszBPHU",
            authDomain: "b3app-b0c29.firebaseapp.com",
            databaseURL: "https://b3app-b0c29-default-rtdb.firebaseio.com",
            projectId: "b3app-b0c29",
            storageBucket: "b3app-b0c29.firebasestorage.app",
            messagingSenderId: "1000910332829",
            appId: "1:1000910332829:web:a1bc233e638afed9b90574"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const searchResultsList = document.getElementById('search-results');
        const noResultsElement = document.getElementById('no-results');

        // UIè¦ç´ ã®å–å¾—
        const timeSearchTab = document.getElementById('time-search-tab');
        const nameSearchTab = document.getElementById('name-search-tab');
        const timeSearchPanel = document.getElementById('time-search-panel');
        const nameSearchPanel = document.getElementById('name-search-panel');

        const selectPeriodFilter = document.getElementById('select-period-filter');
        const selectDayFilter = document.getElementById('select-day-filter');
        const selectTimeFilter = document.getElementById('select-time-filter');
        const searchButton = document.getElementById('search-button');

        const subjectNameInput = document.getElementById('subject-name-input');
        const nameSearchButton = document.getElementById('name-search-button');

        let allSubjectsData = {};

        /**
         * é–‹è¬›åŒºåˆ†ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼ç­‰ï¼‰ã‚’å‰æœŸ/å¾ŒæœŸ/é€šå¹´ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹
         */
        function mapOfferingDivision(division) {
            if (!division) return 'ä¸æ˜';
            if (division.includes('ç¬¬1ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('ç¬¬2ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('å‰æœŸ')) {
                return 'å‰æœŸ';
            }
            if (division.includes('ç¬¬3ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('ç¬¬4ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼') || division.includes('å¾ŒæœŸ')) {
                return 'å¾ŒæœŸ';
            }
            if (division.includes('é€šå¹´')) {
                return 'é€šå¹´';
            }
            return 'ãã®ä»–';
        }

        /**
         * æ¤œç´¢çµæœã‚’è¡¨ç¤ºã™ã‚‹
         */
        function displayResults(subjectsToDisplay) {
            searchResultsList.innerHTML = '';
            noResultsElement.style.display = 'none';

            if (Object.keys(subjectsToDisplay).length === 0) {
                noResultsElement.style.display = 'block';
                return;
            }

            for (const subjectCode in subjectsToDisplay) {
                const subject = subjectsToDisplay[subjectCode];
                const listItem = document.createElement('li');

                let tagsHtml = '';
                if (subject.tag1) {
                    const tagClass = subject.tag1 === 'XD' ? 'tag-xd' : '';
                    tagsHtml = `<div style="margin-top:5px;">
                                    <span class="subject-tag ${tagClass}">${subject.tag1}</span>
                                </div>`;
                }
                
                const term = subject['é–‹è¬›åŒºåˆ†'] ? subject['é–‹è¬›åŒºåˆ†'].split('ï¼')[0] : 'é–‹è¬›åŒºåˆ†ä¸æ˜';

                listItem.innerHTML = `
                    <a href="detail.html?code=${encodeURIComponent(subjectCode)}" target="_blank">
                        ${subject['ç§‘ç›®å'] ?? 'ä¸æ˜ãªç§‘ç›®'}
                        <div class="result-details">
                            ${subject['æ•™å“¡å'] ?? 'æ•™å“¡ä¸æ˜'} |
                            ${subject['æ›œé™'] ?? 'æ›œé™ä¸æ˜'} | 
                            ${term} | 
                            ${subject['å˜ä½æ•°'] ?? '?'}å˜ä½
                            ${tagsHtml}
                        </div>
                    </a>
                `;
                searchResultsList.appendChild(listItem);
            }
        }
        
        /**
         * æ™‚é–“å¸¯ã§ç§‘ç›®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹
         */
        function filterAndDisplayTimeSearch(periodFilter, dayFilter, timeFilter) {
            let filtered = {};
            for (const subjectCode in allSubjectsData) {
                const subject = allSubjectsData[subjectCode];

                const subjectPeriod = mapOfferingDivision(subject['é–‹è¬›åŒºåˆ†']);
                if (periodFilter !== 'å…¨ã¦' && subjectPeriod !== periodFilter) {
                    continue;
                }

                let timeSlotMatches = false;
                if (dayFilter === 'å…¨ã¦' && timeFilter === 'å…¨ã¦') {
                    timeSlotMatches = true;
                } else if (subject['æ›œé™']) {
                    const timeSlots = subject['æ›œé™'].split(',');
                    for (const slot of timeSlots) {
                        const regex = /([æœˆç«æ°´æœ¨é‡‘])\S*\s*(\d+)/;
                        const match = slot.match(regex);

                        if (match) {
                            const dayChar = match[1];
                            const timePart = match[2];

                            const dayMatches = (dayFilter === 'å…¨ã¦' || dayChar === dayFilter);
                            const timeMatches = (timeFilter === 'å…¨ã¦' || timePart === timeFilter);

                            if (dayMatches && timeMatches) {
                                timeSlotMatches = true;
                                break; 
                            }
                        }
                    }
                }

                if (timeSlotMatches) {
                    filtered[subjectCode] = subject;
                }
            }
            displayResults(filtered);
        }

        /**
         * ç§‘ç›®åã§ç§‘ç›®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹
         */
        function filterAndDisplayNameSearch(nameInput) {
            const lowerCaseInput = nameInput.toLowerCase().trim();
            if (!lowerCaseInput) {
                applyCurrentSearchFilter();
                return;
            }
            let filtered = {};
            for (const subjectCode in allSubjectsData) {
                const subject = allSubjectsData[subjectCode];
                const subjectName = (subject['ç§‘ç›®å'] ?? '').toLowerCase();
                if (subjectName.includes(lowerCaseInput)) {
                    filtered[subjectCode] = subject;
                }
            }
            displayResults(filtered);
        }

        /**
         * ç¾åœ¨ã®æ¤œç´¢æ–¹æ³•ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã™ã‚‹
         */
        function applyCurrentSearchFilter() {
            if (timeSearchTab.classList.contains('active')) {
                filterAndDisplayTimeSearch(selectPeriodFilter.value, selectDayFilter.value, selectTimeFilter.value);
            } else if (nameSearchTab.classList.contains('active')) {
                filterAndDisplayNameSearch(subjectNameInput.value);
            }
        }

        /**
         * Firebaseã‹ã‚‰ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
         */
        async function fetchSubjects() {
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            try {
                const [syllabusSnapshot, metaSnapshot] = await Promise.all([
                    get(ref(database, 'syllabus_subjects')),
                    get(ref(database, 'curriculum_meta'))
                ]);
                
                const syllabusData = syllabusSnapshot.val() || {};
                const metaData = metaSnapshot.val() || {};

                allSubjectsData = {};
                for (const code in syllabusData) {
                    allSubjectsData[code] = {
                        ...syllabusData[code],
                        ...(metaData[code] || {})
                    };
                }

                loadingElement.style.display = 'none';
                applyCurrentSearchFilter();

            } catch (error) {
                console.error("Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `ç§‘ç›®æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        timeSearchTab.addEventListener('click', () => {
            timeSearchTab.classList.add('active');
            nameSearchTab.classList.remove('active');
            timeSearchPanel.style.display = 'block';
            nameSearchPanel.style.display = 'none';
            applyCurrentSearchFilter();
        });

        nameSearchTab.addEventListener('click', () => {
            nameSearchTab.classList.add('active');
            timeSearchTab.classList.remove('active');
            nameSearchPanel.style.display = 'block';
            timeSearchPanel.style.display = 'none';
            applyCurrentSearchFilter();
        });

        searchButton.addEventListener('click', applyCurrentSearchFilter);
        nameSearchButton.addEventListener('click', applyCurrentSearchFilter);

        selectPeriodFilter.addEventListener('change', applyCurrentSearchFilter);
        selectDayFilter.addEventListener('change', applyCurrentSearchFilter);
        selectTimeFilter.addEventListener('change', applyCurrentSearchFilter);
        
        subjectNameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                applyCurrentSearchFilter();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        fetchSubjects();
    </script>
</body>
</html>