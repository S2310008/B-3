<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単位計算</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="firebase-config.js"></script>
    <link rel="stylesheet" href="tanni.css">
</head>
<body>
        <nav class="slide-menu" id="slide-menu">
        <button class="close-button" id="close-button">&times;</button>
        <ul>
            <li><a href="home.html">ホーム</a></li>
            <li><a href="tanikeisan.html">単位取得内訳</a></li>
            <li><a href="subject.html">科目検索（曜日・科目名から）</a></li>
            <li><a href="curriculum_map.html">科目検索（カリキュラムから）</a></li>
            <li><a href="tanisimulation.html">予定とシミュレーション</a></li>
        </ul>
    </nav>
    <div class="overlay" id="overlay"></div>

    <div class="header">
        <div class="fusen-2">
            <span class="home-text">単位取得内訳</span>
        </div>

        <div class="header-right">
            <div class="date" id="current-date"></div>
            <button class="menu-button" aria-label="メニューを開く">
                <img src="image/ハンバーガーメニュー.svg" alt="メニューアイコン">
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateElement.textContent = `${year}/${month}/${day}`;
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuButton = document.querySelector('.menu-button');
            const slideMenu = document.getElementById('slide-menu');
            const overlay = document.getElementById('overlay');
            const closeButton = document.getElementById('close-button');

            // メニューを開く
            menuButton.addEventListener('click', () => {
                slideMenu.classList.add('open');
                overlay.classList.add('active');
            });

            // メニューを閉じる（閉じるボタン）
            closeButton.addEventListener('click', () => {
                slideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });

            // メニューを閉じる（オーバーレイ）
            overlay.addEventListener('click', () => {
                slideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });
        });
    </script>
    <div class="container">
        <h1>単位計算</h1>

        <p>すでに取得した科目にチェックを入れ、単位数を計算しましょう。</p>

        <div class="input-section">
            <div>
                <label for="major1Select">第1メジャーを選択:</label>
                <select id="major1Select" onchange="updateCalculations()">
                    <option value="IS">IS</option>
                    <option value="NC">NC</option>
                    <option value="XD">XD</option>
                </select>
            </div>
            <div>
                <label for="major2Select">第2メジャーを選択:</label>
                <select id="major2Select" onchange="updateCalculations()">
                    <option value="IS">IS</option>
                    <option value="NC">NC</option>
                    <option value="XD">XD</option>
                </select>
            </div>
        </div>

        <hr>
        <h2>科目一覧 (時間割)</h2>
        <p>表示したい時間割をクリックしてください。どこの時間割にも含まれていない科目、週に2限以上の科目は「その他」を選択してください。</p>
        <div class="term-filter">
            <label>開講区分:</label>
            <input type="radio" id="termFilterAll" name="termFilter" value="all" checked onchange="handleTermFilterChange()">
            <label for="termFilterAll">全て</label>
            <input type="radio" id="termFilterFormer" name="termFilter" value="前期／the former term" onchange="handleTermFilterChange()">
            <label for="termFilterFormer">前期</label>
            <input type="radio" id="termFilterLatter" name="termFilter" value="後期／the latter term" onchange="handleTermFilterChange()">
            <label for="termFilterLatter">後期</label>
        </div>
        <div class="timetable-tabs" id="timetableTabs">
            </div>

        <div class="subject-list-container">
            <div class="subject-header">
                <div>Tag1</div>
                <div></div>
                <div>Tag2</div>
                <div></div>
                <div>Tag3</div>
                <div></div>
                <div>Tag4</div>
                <div>科目名</div>
                <div>単位</div>
            </div>
            <div id="subjectList">
                </div>
        </div>

        <div class="input-section">
            <p>※チェックした科目以外に、すでに取得済みの単位があれば、以下に手動で入力してください。</p>
            <div>
                <label for="manualKyoyoUnits">教養教育科目:</label>
                <input type="number" id="manualKyoyoUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualKogakuKisoUnits">工学基礎科目:</label>
                <input type="number" id="manualKogakuKisoUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualJohoKisoUnits">情報基礎科目:</label>
                <input type="number" id="manualJohoKisoUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualJohoOyoUnits">情報応用科目:</label>
                <input type="number" id="manualJohoOyoUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualMajor1Units"><span id="manualMajor1Label">第1メジャー科目</span>:</label>
                <input type="number" id="manualMajor1Units" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualMajor2Units"><span id="manualMajor2Label">第2メジャー科目</span>:</label>
                <input type="number" id="manualMajor2Units" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualOtherMajorUnits">その他メジャー科目:</label>
                <input type="number" id="manualOtherMajorUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualSotsukenUnits">卒業研究:</label>
                <input type="number" id="manualSotsukenUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
            <div>
                <label for="manualJiyuSentakuUnits">自由選択科目:</label>
                <input type="number" id="manualJiyuSentakuUnits" value="0" min="0" onchange="updateCalculations()"> 単位
            </div>
        </div>

        <div class="results-section">
            <h2>取得単位数合計</h2>
            <div>
                <span class="result-item">教養教育科目:</span> <span id="acquiredKyoyo">0</span> / <span id="targetKyoyo">24</span> 単位 (<span id="remainingKyoyo">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item">工学基礎科目:</span> <span id="acquiredKogakuKiso">0</span> / <span id="targetKogakuKiso">16</span> 単位 (<span id="remainingKogakuKiso">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item">情報基礎科目:</span> <span id="acquiredJohoKiso">0</span> / <span id="targetJohoKiso">12</span> 単位 (<span id="remainingJohoKiso">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item">情報応用科目:</span> <span id="acquiredJohoOyo">0</span> / <span id="targetJohoOyo">4</span> 単位 (<span id="remainingJohoOyo">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item"><span id="major1Label">第1メジャー科目</span>:</span> <span id="acquiredMajor1">0</span> / <span id="targetMajor1">28</span> 単位 (<span id="remainingMajor1">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item"><span id="major2Label">第2メジャー科目</span>:</span> <span id="acquiredMajor2">0</span> / <span id="targetMajor2">14</span> 単位 (<span id="remainingMajor2">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item">その他メジャー科目:</span> <span id="acquiredOtherMajor">0</span> / <span id="targetOtherMajor">10</span> 単位 (<span id="remainingOtherMajor">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item">卒業研究:</span> <span id="acquiredSotsuken">0</span> / <span id="targetSotsuken">8</span> 単位 (<span id="remainingSotsuken">0</span> 単位不足)
            </div>
            <div>
                <span class="result-item">自由選択科目:</span> <span id="acquiredJiyuSentaku">0</span> / <span id="targetJiyuSentaku">8</span> 単位 (<span id="remainingJiyuSentaku">0</span> 単位不足)
            </div>
        </div>

        <div class="total-summary">
            <h3>全体の単位状況</h3>
            <div>
                <span class="result-item">全体の目標取得単位数:</span> <span id="totalTarget">0</span> 単位
            </div>
            <div>
                <span class="result-item">全体の現在取得済み単位数:</span> <span id="totalAcquired">0</span> 単位
            </div>
            <div>
                <span class="result-item">全体の残り単位数:</span> <span id="totalRemaining">0</span> 単位
            </div>
        </div>

        <div class="chart-container">
            <h2>各科目の達成状況グラフ</h2>
            <div id="requiredWarning" class="required-warning" style="white-space: pre-wrap; display: none;">必修科目を履修できていません</div>
            <canvas id="unitStatusChart"></canvas>
        </div>

        <div class="navigation">
            <a href="tanisimulation.html">単位シミュレーションへ</a>
        </div>
    </div>

    <script>
        const tagToCategoryMap = {
            "その他": "otherMajor",
            "連携": "jiyuSentaku",
            "教養": "kyoyo",
            "工学基礎": "kogakuKiso",
            "工学基礎必修": "kogakuKiso",
            "工学基礎必履修": "kogakuKiso",
            "情報基礎必修": "johoKiso",
            "情報応用必修": "johoOyo",
            "英語必修": "kyoyo",
            "誘い必修": "kyoyo",
            "情報処理必修": "kyoyo",
            "わかやま必修": "kyoyo"
        };

        const requiredTags = ["工学基礎必修", "情報基礎必修", "情報応用必修", "誘い必修", "わかやま必修", "英語必修"];

        let targetUnits = {
            kyoyo: 24, kogakuKiso: 16, johoKiso: 12, johoOyo: 4,
            major1: 28, major2: 14, otherMajor: 10, sotsuken: 8, jiyuSentaku: 8
        };

        const majorTargetUnits = {
            IS: { major1: 28, major2: 14 },
            NC: { major1: 28, major2: 14 },
            XD: { major1: 28, major2: 14 }
        };

        let unitStatusChart;
        let allSubjects = [];
        let currentFilter = '月／Mon　1';
        let currentTermFilter = 'all'; // 開講区分フィルターを追加
        let checkedSubjectTags = {};

        const calculationDataKey = 'tanikeisanData';

        const daysShort = ['月', '火', '水', '木', '金'];
        const daysFull = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
        const periods = ['1', '2', '3', '4', '5', '6'];
        const allTimeSlots = [];

        daysShort.forEach((dayShort, index) => {
            periods.forEach(period => {
                allTimeSlots.push(`${dayShort}／${daysFull[index]}　${period}`);
            });
        });
        allTimeSlots.push('他／Otr');

        function calculateAcquiredUnits(currentAcquired) {
            const acquired = { ...currentAcquired };
            const major1Overflow = Math.max(0, acquired.major1 - targetUnits.major1);
            if (major1Overflow > 0) {
                acquired.otherMajor += major1Overflow;
                acquired.major1 = targetUnits.major1;
            }

            const major2Overflow = Math.max(0, acquired.major2 - targetUnits.major2);
            if (major2Overflow > 0) {
                acquired.otherMajor += major2Overflow;
                acquired.major2 = targetUnits.major2;
            }

            const otherMajorToJiyuSentaku = Math.max(0, acquired.otherMajor - targetUnits.otherMajor);
            if (otherMajorToJiyuSentaku > 0) {
                acquired.jiyuSentaku += otherMajorToJiyuSentaku;
                acquired.otherMajor = targetUnits.otherMajor;
            }

            const kyoyoOverflow = Math.max(0, acquired.kyoyo - targetUnits.kyoyo);
            if (kyoyoOverflow > 0) {
                acquired.jiyuSentaku += kyoyoOverflow;
                acquired.kyoyo = targetUnits.kyoyo;
            }

            const kogakuKisoOverflow = Math.max(0, acquired.kogakuKiso - targetUnits.kogakuKiso);
            if (kogakuKisoOverflow > 0) {
                acquired.jiyuSentaku += kogakuKisoOverflow;
                acquired.kogakuKiso = targetUnits.kogakuKiso;
            }

            const johoKisoOverflow = Math.max(0, acquired.johoKiso - targetUnits.johoKiso);
            if (johoKisoOverflow > 0) {
                acquired.jiyuSentaku += johoKisoOverflow;
                acquired.johoKiso = targetUnits.johoKiso;
            }

            const johoOyoOverflow = Math.max(0, acquired.johoOyo - targetUnits.johoOyo);
            if (johoOyoOverflow > 0) {
                acquired.jiyuSentaku += johoOyoOverflow;
                acquired.johoOyo = targetUnits.johoOyo;
            }

            const results = {};
            let totalAcquiredForGraduation = 0;
            let totalRemainingSum = 0;
            let totalTargetUnitsSum = 0;

            for (const category in targetUnits) {
                if (targetUnits.hasOwnProperty(category)) {
                    const finalAcquiredForCategory = Math.min(acquired[category], targetUnits[category]);
                    results[category] = Math.max(0, targetUnits[category] - finalAcquiredForCategory);

                    if (category !== 'jiyuSentaku') {
                        totalAcquiredForGraduation += finalAcquiredForCategory;
                    }
                    totalTargetUnitsSum += targetUnits[category];
                }
            }
            results.jiyuSentaku = Math.max(0, targetUnits.jiyuSentaku - acquired.jiyuSentaku);
            totalAcquiredForGraduation += acquired.jiyuSentaku;

            results.totalAcquired = totalAcquiredForGraduation;

            for (const category in results) {
                if (results.hasOwnProperty(category) && category !== 'totalAcquired' && category !== 'totalRemaining' && category !== 'totalTargetUnits' && category !== 'actualAcquired') {
                    totalRemainingSum += results[category];
                }
            }
            results.totalRemaining = totalRemainingSum;
            results.actualAcquired = acquired;
            results.totalTargetUnits = totalTargetUnitsSum;

            return results;
        }

        function updateDisplayMajorLabelsAndTargets() {
            const major1 = document.getElementById('major1Select').value;
            const major2 = document.getElementById('major2Select').value;

            targetUnits.major1 = majorTargetUnits[major1].major1;
            targetUnits.major2 = majorTargetUnits[major2].major2;

            document.getElementById('major1Label').textContent = `第1メジャー科目 (${major1})`;
            document.getElementById('major2Label').textContent = `第2メジャー科目 (${major2})`;
            document.getElementById('manualMajor1Label').textContent = `第1メジャー科目 (${major1})`;
            document.getElementById('manualMajor2Label').textContent = `第2メジャー科目 (${major2})`;
        }

        function updateCalculations() {
            updateDisplayMajorLabelsAndTargets();

            const acquiredUnits = {};
            Object.keys(targetUnits).forEach(key => acquiredUnits[key] = 0);

            const major1Selected = document.getElementById('major1Select').value;
            const major2Selected = document.getElementById('major2Select').value;
            const majorTags = ['IS', 'NC', 'XD'];

            const checkedRequiredTags = new Set();
            const allRequiredTags = new Set(requiredTags);
            const englishRequiredSubjects = new Set();
            let englishRequiredTotalUnits = 0;
            let johoShoriHisshuUnits = 0;

            const generalHisshuSubjects = new Set();
            const isHisshuSubjects = new Set();
            let isSentakuHisshuUnits = 0;
            let xdSentakuHisshuUnits = 0;
            const ncHisshuSubjects = new Set();

            const checkedNormalUnitsTag1 = {};
            const checkedNormalUnitsTag2_3 = {};
            Object.keys(targetUnits).forEach(key => {
                checkedNormalUnitsTag1[key] = 0;
                checkedNormalUnitsTag2_3[key] = 0;
            });


            allSubjects.forEach(subject => {
                const checkboxIdPrefix = `chk-${subject.id}-`;

                let checkedTagKey = null;
                if ((subject.tag2 || subject.tag3) && (checkedSubjectTags[checkboxIdPrefix + 'tag1'] || checkedSubjectTags[checkboxIdPrefix + 'tag2'] || checkedSubjectTags[checkboxIdPrefix + 'tag3'])) {
                    checkedTagKey = checkedSubjectTags[checkboxIdPrefix + 'tag2'] ? 'tag2' : checkedSubjectTags[checkboxIdPrefix + 'tag3'] ? 'tag3' : 'tag1';
                } else if (checkedSubjectTags[checkboxIdPrefix + 'tag1']) {
                    checkedTagKey = 'tag1';
                } else if (checkedSubjectTags[checkboxIdPrefix + 'tag4']) {
                    checkedTagKey = 'tag4';
                }

                if (checkedTagKey) {
                    const units = parseInt(subject['単位数']) || 0;
                    const tagValue = subject[checkedTagKey];
                    const tag4Value = subject.tag4;
                    let category = tagToCategoryMap[tagValue];

                    if (allRequiredTags.has(tagValue)) {
                        if (tagValue === "英語必修") {
                            englishRequiredSubjects.add(subject['科目名']);
                            englishRequiredTotalUnits += units;
                        } else {
                            checkedRequiredTags.add(tagValue);
                        }
                    }

                    if (tagValue === "情報処理必修") {
                         johoShoriHisshuUnits += units;
                    }

                    if (tag4Value === "必修") {
                        generalHisshuSubjects.add(subject.id);
                    }
                    if (tag4Value === "IS必修") {
                        isHisshuSubjects.add(subject.id);
                    }
                    if (tag4Value === "IS選択必修") {
                        isSentakuHisshuUnits += units;
                    }
                    if (tag4Value === "XD選択必修") {
                        xdSentakuHisshuUnits += units;
                    }
                    if (tag4Value === "NC必修") {
                        ncHisshuSubjects.add(subject.id);
                    }

                    if (majorTags.includes(tagValue)) {
                        if (tagValue === major1Selected) {
                            category = 'major1';
                        } else if (tagValue === major2Selected) {
                            category = 'major2';
                        } else {
                            category = 'otherMajor';
                        }
                    }
                    if (acquiredUnits.hasOwnProperty(category)) {
                        acquiredUnits[category] += units;
                        if ((subject.tag2 || subject.tag3) && checkedTagKey !== 'tag4') {
                            checkedNormalUnitsTag2_3[category] += units;
                        } else {
                            checkedNormalUnitsTag1[category] += units;
                        }
                    }
                }
            });

            // 手動入力分の加算
            const manualUnits = {
                kyoyo: parseInt(document.getElementById('manualKyoyoUnits').value) || 0,
                kogakuKiso: parseInt(document.getElementById('manualKogakuKisoUnits').value) || 0,
                johoKiso: parseInt(document.getElementById('manualJohoKisoUnits').value) || 0,
                johoOyo: parseInt(document.getElementById('manualJohoOyoUnits').value) || 0,
                major1: parseInt(document.getElementById('manualMajor1Units').value) || 0,
                major2: parseInt(document.getElementById('manualMajor2Units').value) || 0,
                otherMajor: parseInt(document.getElementById('manualOtherMajorUnits').value) || 0,
                sotsuken: parseInt(document.getElementById('manualSotsukenUnits').value) || 0,
                jiyuSentaku: parseInt(document.getElementById('manualJiyuSentakuUnits').value) || 0
            };

            for (const key in manualUnits) {
                if (manualUnits.hasOwnProperty(key) && acquiredUnits.hasOwnProperty(key)) {
                    acquiredUnits[key] += manualUnits[key];
                    checkedNormalUnitsTag1[key] += manualUnits[key];
                }
            }

            const requiredWarningElement = document.getElementById('requiredWarning');
            let isAllRequiredChecked = true;
            let warningMessage = "";

            requiredTags.filter(tag => tag !== "英語必修" && tag !== "情報処理必修").forEach(tag => {
                if (!checkedRequiredTags.has(tag)) {
                    isAllRequiredChecked = false;
                    warningMessage += `・${tag}が履修できていません。\n`;
                }
            });
            const englishRequiredCourses = ["英語Ⅰ／EnglishⅠ", "英語Ⅱ／EnglishⅡ", "英語Ⅲ／EnglishⅢ", "英語Ⅳ／EnglishⅣ"];
            const hasAllEnglishCourses = englishRequiredCourses.every(course => englishRequiredSubjects.has(course));
            if (englishRequiredTotalUnits < 8 || !hasAllEnglishCourses) {
                isAllRequiredChecked = false;
                warningMessage += `・英語必修の8単位が取得できていません。\n`;
            }
            if (johoShoriHisshuUnits < 4) {
                 isAllRequiredChecked = false;
                 warningMessage += `・情報処理必修の4単位が取得できていません。\n`;
            }
            const checkedGeneralHisshuSubjects = allSubjects.filter(subject => {
                return (subject.tag4 === "必修" && ['tag1', 'tag2', 'tag3', 'tag4'].some(tagKey => checkedSubjectTags[`chk-${subject.id}-${tagKey}`]));
            });
            const allGeneralHisshuSubjects = allSubjects.filter(subject => subject.tag4 === "必修");
            if (checkedGeneralHisshuSubjects.length !== allGeneralHisshuSubjects.length) {
                isAllRequiredChecked = false;
                warningMessage += `・メジャー必修科目が履修できていません。\n`;
            }

            if (major1Selected === 'IS' || major2Selected === 'IS') {
                const checkedISHisshuSubjects = allSubjects.filter(subject => {
                    return (subject.tag4 === "IS必修" && ['tag1', 'tag2', 'tag3', 'tag4'].some(tagKey => checkedSubjectTags[`chk-${subject.id}-${tagKey}`]));
                });
                const allISHisshuSubjects = allSubjects.filter(subject => subject.tag4 === "IS必修");
                if (checkedISHisshuSubjects.length !== allISHisshuSubjects.length) {
                    isAllRequiredChecked = false;
                    warningMessage += `・IS必修科目が履修できていません。\n`;
                }
                const checkedISSentakuHisshuUnits = allSubjects.filter(subject => {
                    return (subject.tag4 === "IS選択必修" && ['tag1', 'tag2', 'tag3', 'tag4'].some(tagKey => checkedSubjectTags[`chk-${subject.id}-${tagKey}`]));
                }).reduce((sum, subject) => sum + (parseInt(subject['単位数']) || 0), 0);
                if (checkedISSentakuHisshuUnits < 3) {
                    isAllRequiredChecked = false;
                    warningMessage += `・IS選択必修の3単位が取得できていません。\n`;
                }
            }
            if (major1Selected === 'NC' || major2Selected === 'NC') {
                const checkedNCHisshuSubjects = allSubjects.filter(subject => {
                    return (subject.tag4 === "NC必修" && ['tag1', 'tag2', 'tag3', 'tag4'].some(tagKey => checkedSubjectTags[`chk-${subject.id}-${tagKey}`]));
                });
                const allNCHisshuSubjects = allSubjects.filter(subject => subject.tag4 === "NC必修");
                if (checkedNCHisshuSubjects.length !== allNCHisshuSubjects.length) {
                    isAllRequiredChecked = false;
                    warningMessage += `・NC必修科目が履修できていません。\n`;
                }
            }
            if (major1Selected === 'XD' || major2Selected === 'XD') {
                const checkedXDSentakuHisshuUnits = allSubjects.filter(subject => {
                    return (subject.tag4 === "XD選択必修" && ['tag1', 'tag2', 'tag3', 'tag4'].some(tagKey => checkedSubjectTags[`chk-${subject.id}-${tagKey}`]));
                }).reduce((sum, subject) => sum + (parseInt(subject['単位数']) || 0), 0);
                if (checkedXDSentakuHisshuUnits < 2) {
                    isAllRequiredChecked = false;
                    warningMessage += `・XD選択必修の2単位が取得できていません。\n`;
                }
            }


            if (!isAllRequiredChecked) {
                requiredWarningElement.style.display = 'block';
                requiredWarningElement.textContent = `以下の必修科目を満たしていません:\n${warningMessage}`;
            } else {
                requiredWarningElement.style.display = 'none';
            }


            const results = calculateAcquiredUnits(acquiredUnits);

            document.getElementById('acquiredKyoyo').textContent = Math.min(results.actualAcquired.kyoyo, targetUnits.kyoyo);
            document.getElementById('remainingKyoyo').textContent = results.kyoyo;
            document.getElementById('targetKyoyo').textContent = targetUnits.kyoyo;

            document.getElementById('acquiredKogakuKiso').textContent = Math.min(results.actualAcquired.kogakuKiso, targetUnits.kogakuKiso);
            document.getElementById('remainingKogakuKiso').textContent = results.kogakuKiso;
            document.getElementById('targetKogakuKiso').textContent = targetUnits.kogakuKiso;

            document.getElementById('acquiredJohoKiso').textContent = Math.min(results.actualAcquired.johoKiso, targetUnits.johoKiso);
            document.getElementById('remainingJohoKiso').textContent = results.johoKiso;
            document.getElementById('targetJohoKiso').textContent = targetUnits.johoKiso;

            document.getElementById('acquiredJohoOyo').textContent = Math.min(results.actualAcquired.johoOyo, targetUnits.johoOyo);
            document.getElementById('remainingJohoOyo').textContent = results.johoOyo;
            document.getElementById('targetJohoOyo').textContent = targetUnits.johoOyo;

            document.getElementById('acquiredMajor1').textContent = Math.min(results.actualAcquired.major1, targetUnits.major1);
            document.getElementById('remainingMajor1').textContent = results.major1;
            document.getElementById('targetMajor1').textContent = targetUnits.major1;

            document.getElementById('acquiredMajor2').textContent = Math.min(results.actualAcquired.major2, targetUnits.major2);
            document.getElementById('remainingMajor2').textContent = results.major2;
            document.getElementById('targetMajor2').textContent = targetUnits.major2;

            document.getElementById('acquiredOtherMajor').textContent = Math.min(results.actualAcquired.otherMajor, targetUnits.otherMajor);
            document.getElementById('remainingOtherMajor').textContent = results.otherMajor;
            document.getElementById('targetOtherMajor').textContent = targetUnits.otherMajor;

            document.getElementById('acquiredSotsuken').textContent = Math.min(results.actualAcquired.sotsuken, targetUnits.sotsuken);
            document.getElementById('remainingSotsuken').textContent = results.sotsuken;
            document.getElementById('targetSotsuken').textContent = targetUnits.sotsuken;

            document.getElementById('acquiredJiyuSentaku').textContent = Math.min(results.actualAcquired.jiyuSentaku, targetUnits.jiyuSentaku);
            document.getElementById('remainingJiyuSentaku').textContent = results.jiyuSentaku;
            document.getElementById('targetJiyuSentaku').textContent = targetUnits.jiyuSentaku;

            document.getElementById('totalTarget').textContent = results.totalTargetUnits;
            document.getElementById('totalAcquired').textContent = results.totalAcquired;
            document.getElementById('totalRemaining').textContent = results.totalRemaining;

            updateChart(checkedNormalUnitsTag1, checkedNormalUnitsTag2_3);
            saveDataToLocalStorage();
        }

        function updateChart(checkedNormalUnitsTag1, checkedNormalUnitsTag2_3) {
            const ctx = document.getElementById('unitStatusChart').getContext('2d');
            const labels = Object.keys(targetUnits).map(key => {
                switch(key) {
                    case 'kyoyo': return '教養教育科目';
                    case 'kogakuKiso': return '工学基礎科目';
                    case 'johoKiso': return '情報基礎科目';
                    case 'johoOyo': return '情報応用科目';
                    case 'major1': return `第1メジャー科目 (${document.getElementById('major1Select').value})`;
                    case 'major2': return `第2メジャー科目 (${document.getElementById('major2Select').value})`;
                    case 'otherMajor': return 'その他メジャー科目';
                    case 'sotsuken': return '卒業研究';
                    case 'jiyuSentaku': return '自由選択科目';
                    default: return key;
                }
            });

            const normalDataTag1 = Object.keys(targetUnits).map(key => checkedNormalUnitsTag1[key] || 0);
            const normalDataTag2_3 = Object.keys(targetUnits).map(key => checkedNormalUnitsTag2_3[key] || 0);

            if (unitStatusChart) {
                unitStatusChart.destroy();
            }

            unitStatusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '取得済み ',
                        data: normalDataTag1,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        stack: 'total'
                    }, {
                        label: '取得済み (共有可能科目)',
                        data: normalDataTag2_3,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        stack: 'total'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '単位数'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            stacked: true,
                            barPercentage: 0.9,
                            categoryPercentage: 0.9
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const categoryKey = Object.keys(targetUnits)[context[0].dataIndex];
                                    const target = targetUnits[categoryKey];
                                    const label = labels[context[0].dataIndex];
                                    return `${label} (目標: ${target}単位)`;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.x;
                                    return label + value + '単位';
                                },
                                afterBody: function(context) {
                                    const categoryKey = Object.keys(targetUnits)[context[0].dataIndex];
                                    const target = targetUnits[categoryKey];
                                    const totalAcquired = (checkedNormalUnitsTag1[categoryKey] || 0) + (checkedNormalUnitsTag2_3[categoryKey] || 0);
                                    const remaining = Math.max(0, target - totalAcquired);
                                    return '合計: ' + totalAcquired + '単位, 残り: ' + remaining + '単位';
                                }
                            }
                        }
                    }
                }
            });
        }


        function handleCheckboxChange(changedCheckbox) {
            const subjectId = changedCheckbox.dataset.subjectId;
            const checkboxId = changedCheckbox.id;

            if (changedCheckbox.checked) {
                document.querySelectorAll(`input[type="checkbox"][data-subject-id="${subjectId}"]`).forEach(checkbox => {
                    if (checkbox !== changedCheckbox) {
                        checkbox.checked = false;
                        delete checkedSubjectTags[checkbox.id];
                    }
                });
                checkedSubjectTags[checkboxId] = true;
            } else {
                delete checkedSubjectTags[checkboxId];
            }
            updateCalculations();
        }

        function loadSubjects() {
            const subjectsRef = database.ref('syllabus_subjects');
            subjectsRef.on('value', (snapshot) => {
                const subjectsData = snapshot.val();
                allSubjects = [];
                if (subjectsData) {
                    allSubjects = Object.keys(subjectsData).map(key => ({
                        id: key,
                        ...subjectsData[key]
                    }));
                } else {
                    console.warn('科目データがありません。');
                }
                restoreSavedState();
                displaySubjectsByFilter(currentFilter);
            }, (error) => {
                console.error("Firebaseから科目データの読み込みに失敗しました:", error);
                alert("科目データの読み込みに失敗しました。インターネット接続を確認してください。");
            });
        }

        function displaySubjectsByFilter(filter) {
            currentFilter = filter;
            const subjectListDiv = document.getElementById('subjectList');
            subjectListDiv.innerHTML = '';

            document.querySelectorAll('.timetable-tabs button').forEach(button => {
                if (button.dataset.filter === filter) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            let filteredSubjects = [];

            if (filter === '他／Otr') {
                const standardTimeSlots = allTimeSlots.slice(0, -1);
                filteredSubjects = allSubjects.filter(subject => {
                    const yougen = subject['曜限'];
                    if (!yougen) return true;
                    let matchesTerm = false;
                    const subjectTerm = subject['開講区分'];
                    if (currentTermFilter === 'all') {
                        matchesTerm = true;
                    } else if (currentTermFilter === '前期／the former term') {
                        matchesTerm = (subjectTerm === '前期／the former term' || subjectTerm === '第1クォーター／1Q' || subjectTerm === '第2クォーター／2Q'|| subjectTerm === '通年／a normal year');
                    } else if (currentTermFilter === '後期／the latter term') {
                        matchesTerm = (subjectTerm === '後期／the latter term' || subjectTerm === '第3クォーター／3Q' || subjectTerm === '第4クォーター／4Q'|| subjectTerm === '通年／a normal year');
                    }
                    if (Array.isArray(yougen)) {
                        const containsOtr = yougen.includes('他／Otr');
                        const containsAnyStandardSlot = yougen.some(y => standardTimeSlots.includes(y));
                        return (containsOtr || (!containsAnyStandardSlot && yougen.length > 0)) && matchesTerm;
                    } else if (typeof yougen === 'string') {
                        return (yougen === '他／Otr' || !standardTimeSlots.includes(yougen)) && matchesTerm;
                    }
                    return false;
                });
            } else {
                filteredSubjects = allSubjects.filter(subject => {
                    const yougen = subject['曜限'];
                    let matchesTerm = false;
                    const subjectTerm = subject['開講区分'];
                    if (currentTermFilter === 'all') {
                        matchesTerm = true;
                    } else if (currentTermFilter === '前期／the former term') {
                        matchesTerm = (subjectTerm === '前期／the former term' || subjectTerm === '第1クォーター／1Q' || subjectTerm === '第2クォーター／2Q' || subjectTerm === '通年／a normal year');
                    } else if (currentTermFilter === '後期／the latter term') {
                        matchesTerm = (subjectTerm === '後期／the latter term' || subjectTerm === '第3クォーター／3Q' || subjectTerm === '第4クォーター／4Q' || subjectTerm === '通年／a normal year');
                    }
                    if (Array.isArray(yougen)) {
                        return yougen.includes(filter) && matchesTerm; // 変更
                    } else if (typeof yougen === 'string') {
                       return yougen === filter && matchesTerm; // 変更
                    }
                    return false;
                });
            }

            filteredSubjects.forEach(subject => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('subject-item');
                itemDiv.dataset.subjectId = subject.id;

                const tag1CheckboxId = `chk-${subject.id}-tag1`;
                const tag2CheckboxId = `chk-${subject.id}-tag2`;
                const tag3CheckboxId = `chk-${subject.id}-tag3`;
                const tag4CheckboxId = `chk-${subject.id}-tag4`;

                const tag1Content = subject.tag1 ? `<div>${subject.tag1}</div><div><input type="checkbox" id="${tag1CheckboxId}" data-tag="${subject.tag1}" data-units="${subject['単位数']}" data-subject-id="${subject.id}" onchange="handleCheckboxChange(this)"></div>` : `<div></div><div></div>`;
                const tag2Content = subject.tag2 ? `<div>${subject.tag2}</div><div><input type="checkbox" id="${tag2CheckboxId}" data-tag="${subject.tag2}" data-units="${subject['単位数']}" data-subject-id="${subject.id}" onchange="handleCheckboxChange(this)"></div>` : `<div></div><div></div>`;
                const tag3Content = subject.tag3 ? `<div>${subject.tag3}</div><div><input type="checkbox" id="${tag3CheckboxId}" data-tag="${subject.tag3}" data-units="${subject['単位数']}" data-subject-id="${subject.id}" onchange="handleCheckboxChange(this)"></div>` : `<div></div><div></div>`;

                itemDiv.innerHTML = `
                    ${tag1Content}
                    ${tag2Content}
                    ${tag3Content}
                    <div>${subject.tag4 || ''}</div>
                    <div>${subject['科目名'] || ''}</div>
                    <div class="units">${subject['単位数'] || 0}</div>
                `;
                subjectListDiv.appendChild(itemDiv);
            });
            restoreCheckboxStates();
        }
        function handleTermFilterChange() {
        // 現在チェックされている開講区分ラジオボタンの値を取得
                const selectedTermFilter = document.querySelector('input[name="termFilter"]:checked').value;
        // グローバル変数currentTermFilterを更新
                currentTermFilter = selectedTermFilter;
        // 現在の曜限フィルターを維持したまま、科目リストを再表示
                displaySubjectsByFilter(currentFilter); 
        }
        function createTimetableTabs() {
            const timetableTabsDiv = document.getElementById('timetableTabs');
            timetableTabsDiv.innerHTML = '';

            allTimeSlots.forEach(slot => {
                const button = document.createElement('button');
                button.textContent = slot.replace('／', '/').replace('Mon', '月').replace('Tue', '火').replace('Wed', '水').replace('Thu', '木').replace('Fri', '金').replace('Otr', 'その他').replace('　', ' ');
                button.dataset.filter = slot;
                button.onclick = () => displaySubjectsByFilter(slot);
                timetableTabsDiv.appendChild(button);
            });
        }

        function saveDataToLocalStorage() {
            const checkedNormalUnitsTag1 = {};
            const checkedNormalUnitsTag2_3 = {};
            Object.keys(targetUnits).forEach(key => {
                checkedNormalUnitsTag1[key] = 0;
                checkedNormalUnitsTag2_3[key] = 0;
            });
            
            const major1Selected = document.getElementById('major1Select').value;
            const major2Selected = document.getElementById('major2Select').value;
            const majorTags = ['IS', 'NC', 'XD'];
            
            const acquiredUnits = {};
            Object.keys(targetUnits).forEach(key => acquiredUnits[key] = 0);
            
            allSubjects.forEach(subject => {
                const checkboxIdPrefix = `chk-${subject.id}-`;
                
                let checkedTagKey = null;
                if ((subject.tag2 || subject.tag3) && (checkedSubjectTags[checkboxIdPrefix + 'tag1'] || checkedSubjectTags[checkboxIdPrefix + 'tag2'] || checkedSubjectTags[checkboxIdPrefix + 'tag3'])) {
                    checkedTagKey = checkedSubjectTags[checkboxIdPrefix + 'tag2'] ? 'tag2' : checkedSubjectTags[checkboxIdPrefix + 'tag3'] ? 'tag3' : 'tag1';
                } else if (checkedSubjectTags[checkboxIdPrefix + 'tag1']) {
                    checkedTagKey = 'tag1';
                } else if (checkedSubjectTags[checkboxIdPrefix + 'tag4']) {
                    checkedTagKey = 'tag4';
                }

                if (checkedTagKey) {
                    const units = parseInt(subject['単位数']) || 0;
                    const tagValue = subject[checkedTagKey];
                    let category = tagToCategoryMap[tagValue];
                    
                    if (majorTags.includes(tagValue)) {
                        if (tagValue === major1Selected) {
                            category = 'major1';
                        } else if (tagValue === major2Selected) {
                            category = 'major2';
                        } else {
                            category = 'otherMajor';
                        }
                    }
                    if (acquiredUnits.hasOwnProperty(category)) {
                        acquiredUnits[category] += units;
                        if ((subject.tag2 || subject.tag3) && checkedTagKey !== 'tag4') {
                            checkedNormalUnitsTag2_3[category] += units;
                        } else {
                            checkedNormalUnitsTag1[category] += units;
                        }
                    }
                }
            });
            
            const manualUnits = {
                kyoyo: parseInt(document.getElementById('manualKyoyoUnits').value) || 0,
                kogakuKiso: parseInt(document.getElementById('manualKogakuKisoUnits').value) || 0,
                johoKiso: parseInt(document.getElementById('manualJohoKisoUnits').value) || 0,
                johoOyo: parseInt(document.getElementById('manualJohoOyoUnits').value) || 0,
                major1: parseInt(document.getElementById('manualMajor1Units').value) || 0,
                major2: parseInt(document.getElementById('manualMajor2Units').value) || 0,
                otherMajor: parseInt(document.getElementById('manualOtherMajorUnits').value) || 0,
                sotsuken: parseInt(document.getElementById('manualSotsukenUnits').value) || 0,
                jiyuSentaku: parseInt(document.getElementById('manualJiyuSentakuUnits').value) || 0
            };

            for (const key in manualUnits) {
                if (manualUnits.hasOwnProperty(key)) {
                    acquiredUnits[key] += manualUnits[key];
                    checkedNormalUnitsTag1[key] += manualUnits[key];
                }
            }
            
            const dataToSave = {
                major1: major1Selected,
                major2: major2Selected,
                manualUnits: manualUnits,
                checkedSubjects: checkedSubjectTags,
                acquiredUnits: acquiredUnits,
                checkedNormalUnitsTag1: checkedNormalUnitsTag1,
                checkedNormalUnitsTag2_3: checkedNormalUnitsTag2_3,
                selectedMajors: {
                    major1: major1Selected,
                    major2: major2Selected
                },
                currentFilter: currentFilter,
                currentTermFilter: currentTermFilter // Save the new filter
            };
            localStorage.setItem(calculationDataKey, JSON.stringify(dataToSave));
            console.log('単位計算データをローカルストレージに保存しました:', dataToSave);
        }

        function restoreSavedState() {
            const savedData = localStorage.getItem(calculationDataKey);
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('major1Select').value = data.major1 || 'IS';
                document.getElementById('major2Select').value = data.major2 || 'IS';
                if (data.manualUnits) {
                    document.getElementById('manualKyoyoUnits').value = data.manualUnits.kyoyo || 0;
                    document.getElementById('manualKogakuKisoUnits').value = data.manualUnits.kogakuKiso || 0;
                    document.getElementById('manualJohoKisoUnits').value = data.manualUnits.johoKiso || 0;
                    document.getElementById('manualJohoOyoUnits').value = data.manualUnits.johoOyo || 0;
                    document.getElementById('manualMajor1Units').value = data.manualUnits.major1 || 0;
                    document.getElementById('manualMajor2Units').value = data.manualUnits.major2 || 0;
                    document.getElementById('manualOtherMajorUnits').value = data.manualUnits.otherMajor || 0;
                    document.getElementById('manualSotsukenUnits').value = data.manualUnits.sotsuken || 0;
                    document.getElementById('manualJiyuSentakuUnits').value = data.manualUnits.jiyuSentaku || 0;
                }
                checkedSubjectTags = data.checkedSubjects || {};
                currentFilter = data.currentFilter || '月／Mon　1';
                currentTermFilter = data.currentTermFilter || 'all'; // Restore the new filter

                const termFilterRadio = document.getElementById(`termFilter${currentTermFilter === 'all' ? 'All' : (currentTermFilter === '前期／the former term' ? 'Former' : 'Latter')}`);
                if (termFilterRadio) {
                    termFilterRadio.checked = true;
            }
        }
    }

        function restoreCheckboxStates() {
            document.querySelectorAll('input[type="checkbox"][id^="chk-"]').forEach(checkbox => {
                checkbox.checked = !!checkedSubjectTags[checkbox.id];
            });
            updateCalculations();
        }

        document.addEventListener('DOMContentLoaded', () => {
            createTimetableTabs();
            loadSubjects();
        });
    </script>
</body>
</html>