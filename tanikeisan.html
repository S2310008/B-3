<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単位計算</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        /* (スタイルは変更なしなので省略) */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 950px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        p { margin-bottom: 15px; }
        .input-section div, .major-selection-section div {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .input-section label, .major-selection-section label {
            flex: 0 0 180px;
            margin-right: 10px;
            font-weight: bold;
            color: #555;
        }
        .input-section input[type="number"], .major-selection-section select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 80px;
        }
        .major-selection-section select {
            max-width: 100px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #0056b3; }
        .results-section div { margin-bottom: 8px; }
        .result-item { font-weight: bold; color: #0056b3; display: inline-block; width: 220px; }
        .total-summary { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .total-summary .result-item { color: #d9534f; }
        .total-summary #resultTotalAcquired { color: #28a745; }
        .chart-container {
            width: 100%;
            max-width: 700px;
            margin: 30px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
        }
        .navigation { margin-top: 30px; text-align: center; }
        .navigation a {
            display: inline-block;
            padding: 10px 15px;
            margin: 0 10px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .navigation a:hover {
            background-color: #5a6268;
        }

        .subject-list-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .subject-item {
            display: grid;
            grid-template-columns: 20px 80px 80px 80px 100px 1fr 60px;
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .subject-item:last-child {
            border-bottom: none;
        }
        .subject-item label {
            margin: 0;
            font-weight: normal;
            flex: none;
        }
        .subject-item input[type="checkbox"] {
            margin: 0;
        }
        .subject-header {
            font-weight: bold;
            background-color: #e2e2e2;
            padding: 8px 0;
            border-bottom: 2px solid #ccc;
            display: grid;
            grid-template-columns: 20px 80px 80px 80px 100px 1fr 60px;
            gap: 10px;
        }
        .subject-header div {
            text-align: center;
        }
        .subject-header div:nth-child(6) { text-align: left; }
        .subject-header div:nth-child(7) { text-align: center; }
        .subject-item .units {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>単位計算</h1>

        <p>各科目の取得済み単位数を入力して、卒業までの残り単位を計算しましょう。</p>

        <h2>メジャー選択</h2>
        <div class="major-selection-section">
            <div>
                <label for="major1Select">第1メジャー:</label>
                <select id="major1Select">
                    <option value="IS">IS (情報システム)</option>
                    <option value="NC">NC (ネットワークコンピューティング)</option>
                    <option value="XD">XD (XD)</option>
                </select>
            </div>
            <div>
                <label for="major2Select">第2メジャー:</label>
                <select id="major2Select">
                    <option value="IS">IS (情報システム)</option>
                    <option value="NC">NC (ネットワークコンピューティング)</option>
                    <option value="XD">XD (XD)</option>
                </select>
            </div>
        </div>

        <h2>現在の取得単位数</h2>
        <div class="input-section">
            <div>
                <label for="kyoyoUnits">教養教育科目:</label>
                <input type="number" id="kyoyoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="kogakuKisoUnits">工学基礎科目:</label>
                <input type="number" id="kogakuKisoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="johoKisoUnits">情報基礎科目:</label>
                <input type="number" id="johoKisoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="johoOyoUnits">情報応用科目:</label>
                <input type="number" id="johoOyoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="major1Units"><span id="major1Label">第1メジャー科目</span>:</label>
                <input type="number" id="major1Units" value="0" min="0"> 単位
            </div>
            <div>
                <label for="major2Units"><span id="major2Label">第2メジャー科目</span>:</label>
                <input type="number" id="major2Units" value="0" min="0"> 単位
            </div>
            <div>
                <label for="otherMajorUnits">その他メジャー科目:</label>
                <input type="number" id="otherMajorUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="sotsukenUnits">卒業研究:</label>
                <input type="number" id="sotsukenUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="jiyuSentakuUnits">自由選択科目:</label>
                <input type="number" id="jiyuSentakuUnits" value="0" min="0"> 単位
            </div>
        </div>

        <button onclick="updateCalculations()">計算する</button>

        <hr>
        <h2>取得済み科目一覧</h2>
        <p>取得済みの科目にチェックを入れて、単位を自動で加算できます。</p>
        <div class="subject-list-container">
            <div class="subject-header">
                <div></div>
                <div>Tag1</div>
                <div>Tag2</div>
                <div>Tag3</div>
                <div>Tag4</div>
                <div>科目名</div>
                <div>単位</div>
            </div>
            <div id="subjectList">
                </div>
        </div>
        <button onclick="applyCheckedSubjects()">チェックした科目を加算</button>

        <hr>
        <div class="results-section">
            <h2>計算結果</h2>
            <div>
                <span class="result-item">教養教育科目 残り:</span> <span id="resultKyoyo">0</span> 単位
            </div>
            <div>
                <span class="result-item">工学基礎科目 残り:</span> <span id="resultKogakuKiso">0</span> 単位
            </div>
            <div>
                <span class="result-item">情報基礎科目 残り:</span> <span id="resultJohoKiso">0</span> 単位
            </div>
            <div>
                <span class="result-item">情報応用科目 残り:</span> <span id="resultJohoOyo">0</span> 単位
            </div>
            <div>
                <span class="result-item"><span id="resultMajor1Label">第1メジャー科目</span> 残り:</span> <span id="resultMajor1">0</span> 単位
            </div>
            <div>
                <span class="result-item"><span id="resultMajor2Label">第2メジャー科目</span> 残り:</span> <span id="resultMajor2">0</span> 単位
            </div>
            <div>
                <span class="result-item">その他メジャー科目 残り:</span> <span id="resultOtherMajor">0</span> 単位
            </div>
            <div>
                <span class="result-item">卒業研究 残り:</span> <span id="resultSotsuken">0</span> 単位
            </div>
            <div>
                <span class="result-item">自由選択科目 残り:</span> <span id="resultJiyuSentaku">0</span> 単位
            </div>
        </div>

        <div class="total-summary">
            <h3>全体の単位状況</h3>
            <div>
                <span class="result-item">全体の取得済み単位数:</span> <span id="resultTotalAcquired">0</span> 単位
            </div>
            <div>
                <span class="result-item">全体の残りの単位数:</span> <span id="resultTotalRemaining">0</span> 単位
            </div>
        </div>

        <div class="chart-container">
            <h2>各科目の達成状況グラフ</h2>
            <canvas id="tanikeisanChart"></canvas>
        </div>

        <div class="navigation">
            <a href="tanisimulation.html">単位取得計画シミュレーションへ</a>
        </div>
    </div>

    <script>
        const tagToCategoryMap = {
            // IS, NC, XD は動的に処理するためここでは定義しない
            "その他": "otherMajor",
            "連携": "jiyuSentaku",
            "教養": "kyoyo",
            "工学基礎": "kogakuKiso",
            "工学基礎必修": "kogakuKiso",
            "工学基礎必履修":"kogakuKiso",
            "情報基礎必修": "johoKiso",
            "情報応用必修": "johoOyo",
            "英語必修": "kyoyo",
            "誘い必修": "kyoyo",
            "情報処理必修": "kyoyo",
            "わかやま必修": "kyoyo"
        };

        let targetUnits = {
            kyoyo: 24, kogakuKiso: 16, johoKiso: 12, johoOyo: 4,
            major1: 28, major2: 14, otherMajor: 10, sotsuken: 8, jiyuSentaku: 8
        };

        const majorTargetUnits = {
            IS: { major1: 28, major2: 14 },
            NC: { major1: 28, major2: 14 },
            XD: { major1: 28, major2: 14 }
        };

        let tanikeisanChart;
        let allSubjects = [];

        function calculateUnitsWithConversion(initialAcquiredUnits) {
            const currentAcquired = { ...initialAcquiredUnits };

            const major1Overflow = Math.max(0, currentAcquired.major1 - targetUnits.major1);
            if (major1Overflow > 0) {
                currentAcquired.otherMajor += major1Overflow;
                currentAcquired.major1 = targetUnits.major1;
            }

            const major2Overflow = Math.max(0, currentAcquired.major2 - targetUnits.major2);
            if (major2Overflow > 0) {
                currentAcquired.otherMajor += major2Overflow;
                currentAcquired.major2 = targetUnits.major2;
            }

            const kyoyoOverflow = Math.max(0, currentAcquired.kyoyo - targetUnits.kyoyo);
            if (kyoyoOverflow > 0) {
                currentAcquired.jiyuSentaku += kyoyoOverflow;
                currentAcquired.kyoyo = targetUnits.kyoyo;
            }

            const kogakuKisoOverflow = Math.max(0, currentAcquired.kogakuKiso - targetUnits.kogakuKiso);
            if (kogakuKisoOverflow > 0) {
                currentAcquired.jiyuSentaku += kogakuKisoOverflow;
                currentAcquired.kogakuKiso = targetUnits.kogakuKiso;
            }

            const johoKisoOverflow = Math.max(0, currentAcquired.johoKiso - targetUnits.johoKiso);
            if (johoKisoOverflow > 0) {
                currentAcquired.jiyuSentaku += johoKisoOverflow;
                currentAcquired.johoKiso = targetUnits.johoKiso;
            }

            const johoOyoOverflow = Math.max(0, currentAcquired.johoOyo - targetUnits.johoOyo);
            if (johoOyoOverflow > 0) {
                currentAcquired.jiyuSentaku += johoOyoOverflow;
                currentAcquired.johoOyo = targetUnits.johoOyo;
            }

            const otherMajorOverflow = Math.max(0, currentAcquired.otherMajor - targetUnits.otherMajor);
            if (otherMajorOverflow > 0) {
                currentAcquired.jiyuSentaku += otherMajorOverflow;
                currentAcquired.otherMajor = targetUnits.otherMajor;
            }

            const finalResults = {};
            let totalAcquiredForGraduation = 0;
            let totalRemainingSum = 0;

            for (const category in targetUnits) {
                if (targetUnits.hasOwnProperty(category)) {
                    if (category !== 'jiyuSentaku') {
                        const finalAcquiredForCategory = Math.min(currentAcquired[category], targetUnits[category]);
                        finalResults[category] = Math.max(0, targetUnits[category] - finalAcquiredForCategory);
                        totalAcquiredForGraduation += finalAcquiredForCategory;
                    }
                }
            }

            finalResults.jiyuSentaku = Math.max(0, targetUnits.jiyuSentaku - currentAcquired.jiyuSentaku);
            totalAcquiredForGraduation += currentAcquired.jiyuSentaku;

            finalResults.totalAcquired = totalAcquiredForGraduation;

            let recalculatedTotalRemaining = 0;
            for (const category in finalResults) {
                if (finalResults.hasOwnProperty(category) && category !== 'totalAcquired' && category !== 'totalRemaining') {
                    recalculatedTotalRemaining += finalResults[category];
                }
            }
            finalResults.totalRemaining = recalculatedTotalRemaining;

            finalResults.acquiredCategoryUnits = {};
            for (const category in targetUnits) {
                finalResults.acquiredCategoryUnits[category] = currentAcquired[category];
            }

            return finalResults;
        }

        function updateMajorTargetsAndLabels() {
            const major1 = document.getElementById('major1Select').value;
            const major2 = document.getElementById('major2Select').value;

            targetUnits.major1 = majorTargetUnits[major1].major1;
            targetUnits.major2 = majorTargetUnits[major2].major2;

            document.getElementById('major1Label').textContent = `第1メジャー科目 (${major1})`;
            document.getElementById('major2Label').textContent = `第2メジャー科目 (${major2})`;
            document.getElementById('resultMajor1Label').textContent = `第1メジャー科目 (${major1})`;
            document.getElementById('resultMajor2Label').textContent = `第2メジャー科目 (${major2})`;

            updateCalculations();
        }

        function updateCalculations() {
            const acquiredUnits = {
                kyoyo: parseInt(document.getElementById('kyoyoUnits').value) || 0,
                kogakuKiso: parseInt(document.getElementById('kogakuKisoUnits').value) || 0,
                johoKiso: parseInt(document.getElementById('johoKisoUnits').value) || 0,
                johoOyo: parseInt(document.getElementById('johoOyoUnits').value) || 0,
                major1: parseInt(document.getElementById('major1Units').value) || 0,
                major2: parseInt(document.getElementById('major2Units').value) || 0,
                otherMajor: parseInt(document.getElementById('otherMajorUnits').value) || 0,
                sotsuken: parseInt(document.getElementById('sotsukenUnits').value) || 0,
                jiyuSentaku: parseInt(document.getElementById('jiyuSentakuUnits').value) || 0
            };

            const dataToSave = {
                acquiredUnits: acquiredUnits,
                selectedMajors: {
                    major1: document.getElementById('major1Select').value,
                    major2: document.getElementById('major2Select').value
                },
                checkedSubjects: getCheckedSubjectsState()
            };
            localStorage.setItem('tanikeisanData', JSON.stringify(dataToSave));
            console.log('単位データとメジャー選択をローカルストレージに保存しました:', dataToSave);

            const results = calculateUnitsWithConversion(acquiredUnits);

            document.getElementById('resultKyoyo').textContent = results.kyoyo;
            document.getElementById('resultKogakuKiso').textContent = results.kogakuKiso;
            document.getElementById('resultJohoKiso').textContent = results.johoKiso;
            document.getElementById('resultJohoOyo').textContent = results.johoOyo;
            document.getElementById('resultMajor1').textContent = results.major1;
            document.getElementById('resultMajor2').textContent = results.major2;
            document.getElementById('resultOtherMajor').textContent = results.otherMajor;
            document.getElementById('resultSotsuken').textContent = results.sotsuken;
            document.getElementById('resultJiyuSentaku').textContent = results.jiyuSentaku;

            document.getElementById('resultTotalAcquired').textContent = results.totalAcquired;
            document.getElementById('resultTotalRemaining').textContent = results.totalRemaining;

            updateTanikeisanChart(results.acquiredCategoryUnits);
        }

        function updateTanikeisanChart(acquiredDataRaw) {
            const ctx = document.getElementById('tanikeisanChart').getContext('2d');
            
            const labels = Object.keys(targetUnits).map(key => {
                switch(key) {
                    case 'kyoyo': return '教養教育科目';
                    case 'kogakuKiso': return '工学基礎科目';
                    case 'johoKiso': return '情報基礎科目';
                    case 'johoOyo': return '情報応用科目';
                    case 'major1': return `第1メジャー科目 (${document.getElementById('major1Select').value})`;
                    case 'major2': return `第2メジャー科目 (${document.getElementById('major2Select').value})`;
                    case 'otherMajor': return 'その他メジャー科目';
                    case 'sotsuken': return '卒業研究';
                    case 'jiyuSentaku': return '自由選択科目';
                    default: return key;
                }
            });
            
            const acquiredDataForChart = Object.keys(targetUnits).map(key => {
                return Math.min(acquiredDataRaw[key], targetUnits[key]);
            });

            const targetData = Object.keys(targetUnits).map(key => {
                return targetUnits[key];
            });

            if (tanikeisanChart) {
                tanikeisanChart.destroy();
            }

            tanikeisanChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '目標単位数',
                        data: targetData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: '現在の取得済み単位数',
                        data: acquiredDataForChart,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '単位数'
                            },
                            ticks: {
                                stepSize: 1
                            },
                            max: Math.max(...targetData) + 2
                        },
                        y: {
                            stacked: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.x;
                                    const categoryKey = Object.keys(targetUnits)[context.dataIndex];
                                    const target = targetUnits[categoryKey];
                                    
                                    if (context.dataset.label === '目標単位数') {
                                        return label + value + '単位';
                                    } else {
                                        const remaining = Math.max(0, target - value);
                                        return label + value + '単位 (残り: ' + remaining + '単位)';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 科目データをFirebaseから読み込み、表示する関数
        function loadSubjects() {
            const subjectsRef = database.ref('syllabus_subjects'); 
            subjectsRef.on('value', (snapshot) => {
                const subjectsData = snapshot.val();
                const subjectListDiv = document.getElementById('subjectList');
                subjectListDiv.innerHTML = '';
                allSubjects = [];

                if (subjectsData) {
                    allSubjects = Object.keys(subjectsData).map(key => ({
                        id: key, 
                        ...subjectsData[key]
                    }));

                    allSubjects.forEach(subject => {
                        console.log("科目データ (tanikeisan.html):", subject); // デバッグ用にログ出力

                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('subject-item');
                        itemDiv.dataset.subjectId = subject.id;

                        const checkboxIdPrefix = 'chk'; // tanikeisan.html 用のプレフィックス

                        // 最初のカラムにすべてのチェックボックスをまとめる
                        let checkboxesInFirstColumn = '';
                        if (subject.tag1) {
                            checkboxesInFirstColumn += `<input type="checkbox" id="${checkboxIdPrefix}-${subject.id}-tag1" data-tag="${subject.tag1}" data-units="${subject.units}" data-subject-id="${subject.id}" onchange="handleCheckboxChange(this)">`;
                        }
                        if (subject.tag2) {
                            checkboxesInFirstColumn += `<input type="checkbox" id="${checkboxIdPrefix}-${subject.id}-tag2" data-tag="${subject.tag2}" data-units="${subject.units}" data-subject-id="${subject.id}" onchange="handleCheckboxChange(this)">`;
                        }
                        if (subject.tag3) {
                            checkboxesInFirstColumn += `<input type="checkbox" id="${checkboxIdPrefix}-${subject.id}-tag3" data-tag="${subject.tag3}" data-units="${subject.units}" data-subject-id="${subject.id}" onchange="handleCheckboxChange(this)">`;
                        }

                        itemDiv.innerHTML = `
                            <div>${checkboxesInFirstColumn}</div> <div>${subject.tag1 || ''}</div>     <div>${subject.tag2 || ''}</div>     <div>${subject.tag3 || ''}</div>     <div>${subject.tag4 || ''}</div>     <div>${subject.name || ''}</div>     <div class="units">${subject.units || 0}</div> `;
                        subjectListDiv.appendChild(itemDiv);
                    });
                } else {
                    subjectListDiv.innerHTML = '<p>科目データがありません。</p>';
                }
                restoreCheckedSubjectsState();
            }, (error) => {
                console.error("Firebaseから科目データの読み込みに失敗しました:", error);
                alert("科目データの読み込みに失敗しました。インターネット接続を確認してください。");
            });
        }

        function getCheckedSubjectsState() {
            const checkedStates = {};
            document.querySelectorAll('#subjectList input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    checkedStates[checkbox.id] = true;
                }
            });
            return checkedStates;
        }

        function restoreCheckedSubjectsState() {
            const savedData = localStorage.getItem('tanikeisanData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                const checkedSubjects = parsedData.checkedSubjects || {};
                
                document.querySelectorAll('#subjectList input[type="checkbox"]').forEach(checkbox => {
                    if (checkedSubjects[checkbox.id]) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false;
                    }
                });
            }
        }

        function handleCheckboxChange(changedCheckbox) {
            const subjectId = changedCheckbox.dataset.subjectId;
            const checkboxesForSubject = document.querySelectorAll(`input[type="checkbox"][data-subject-id="${subjectId}"]`);

            if (changedCheckbox.checked) {
                checkboxesForSubject.forEach(cb => {
                    if (cb !== changedCheckbox) {
                        cb.checked = false;
                    }
                });
            }
            // チェックボックスの状態が変更されたら、自動的に再計算する
            applyCheckedSubjects(); 
        }

        function applyCheckedSubjects() {
            let tempAcquiredUnits = {
                kyoyo: 0, kogakuKiso: 0, johoKiso: 0, johoOyo: 0,
                major1: 0, major2: 0, otherMajor: 0, sotsuken: 0, jiyuSentaku: 0
            };

            const major1Selected = document.getElementById('major1Select').value;
            const major2Selected = document.getElementById('major2Select').value;
            const majorTags = ['IS', 'NC', 'XD']; // すべてのメジャー関連タグ

            document.querySelectorAll('#subjectList input[type="checkbox"]:checked').forEach(checkbox => {
                const tag = checkbox.dataset.tag;
                const units = parseInt(checkbox.dataset.units) || 0; // ここで単位数を数値として取得

                let category = tagToCategoryMap[tag]; // まずは既存のマップで確認

                // メジャー関連のタグの場合の特殊処理
                if (majorTags.includes(tag)) {
                    if (tag === major1Selected) {
                        category = 'major1';
                    } else if (tag === major2Selected) {
                        category = 'major2';
                    } else {
                        // 選択されなかったメジャー科目は「その他メジャー科目」として扱う
                        category = 'otherMajor';
                    }
                }

                if (tempAcquiredUnits.hasOwnProperty(category)) {
                    tempAcquiredUnits[category] += units;
                } else {
                    console.warn(`不明なカテゴリ: ${category} (タグ: ${tag})`);
                }
            });

            document.getElementById('kyoyoUnits').value = tempAcquiredUnits.kyoyo;
            document.getElementById('kogakuKisoUnits').value = tempAcquiredUnits.kogakuKiso;
            document.getElementById('johoKisoUnits').value = tempAcquiredUnits.johoKiso;
            document.getElementById('johoOyoUnits').value = tempAcquiredUnits.johoOyo;
            document.getElementById('major1Units').value = tempAcquiredUnits.major1;
            document.getElementById('major2Units').value = tempAcquiredUnits.major2;
            document.getElementById('otherMajorUnits').value = tempAcquiredUnits.otherMajor;
            document.getElementById('sotsukenUnits').value = tempAcquiredUnits.sotsuken;
            document.getElementById('jiyuSentakuUnits').value = tempAcquiredUnits.jiyuSentaku;

            updateCalculations();
        }

        window.onload = function() {
            const savedData = localStorage.getItem('tanikeisanData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                const acquiredUnits = parsedData.acquiredUnits;
                const selectedMajors = parsedData.selectedMajors;

                console.log('ローカルストレージから単位データとメジャー選択を読み込みました:', parsedData);
                
                // 手動入力フィールドに値を復元
                document.getElementById('kyoyoUnits').value = acquiredUnits.kyoyo || 0;
                document.getElementById('kogakuKisoUnits').value = acquiredUnits.kogakuKiso || 0;
                document.getElementById('johoKisoUnits').value = acquiredUnits.johoKiso || 0;
                document.getElementById('johoOyoUnits').value = acquiredUnits.johoOyo || 0;
                document.getElementById('major1Units').value = acquiredUnits.major1 || 0;
                document.getElementById('major2Units').value = acquiredUnits.major2 || 0;
                document.getElementById('otherMajorUnits').value = acquiredUnits.otherMajor || 0;
                document.getElementById('sotsukenUnits').value = acquiredUnits.sotsuken || 0;
                document.getElementById('jiyuSentakuUnits').value = acquiredUnits.jiyuSentaku || 0;

                // メジャー選択を復元
                document.getElementById('major1Select').value = selectedMajors.major1 || 'IS';
                document.getElementById('major2Select').value = selectedMajors.major2 || 'IS';

            } else {
                console.warn('ローカルストレージに単位データが見つかりませんでした。初期値を使用します。');
                document.getElementById('major1Select').value = 'IS';
                document.getElementById('major2Select').value = 'IS';
            }

            document.getElementById('major1Select').addEventListener('change', updateMajorTargetsAndLabels);
            document.getElementById('major2Select').addEventListener('change', updateMajorTargetsAndLabels);
            
            loadSubjects(); // 科目リストを読み込み
            updateMajorTargetsAndLabels(); // メジャーターゲットを更新し、初回の計算を実行
        };
    </script>
</body>
</html>