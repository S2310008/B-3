<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単位計算</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        p { margin-bottom: 15px; }
        .input-section div, .major-selection-section div {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .input-section label, .major-selection-section label {
            flex: 0 0 180px;
            margin-right: 10px;
            font-weight: bold;
            color: #555;
        }
        .input-section input[type="number"], .major-selection-section select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 80px;
        }
        .major-selection-section select {
            max-width: 100px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #0056b3; }
        .results-section div { margin-bottom: 8px; }
        .result-item { font-weight: bold; color: #0056b3; display: inline-block; width: 220px; }
        .total-summary { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .total-summary .result-item { color: #d9534f; }
        .total-summary #resultTotalAcquired { color: #28a745; }
        .chart-container {
            width: 100%;
            max-width: 700px;
            margin: 30px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
        }
        .navigation { margin-top: 30px; text-align: center; }
        .navigation a {
            display: inline-block;
            padding: 10px 15px;
            margin: 0 10px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .navigation a:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>単位計算</h1>

        <p>各科目の取得済み単位数を入力して、卒業までの残り単位を計算しましょう。</p>

        <h2>メジャー選択</h2>
        <div class="major-selection-section">
            <div>
                <label for="major1Select">第1メジャー:</label>
                <select id="major1Select">
                    <option value="IS">IS (情報システム)</option>
                    <option value="NC">NC (ネットワークコンピューティング)</option>
                    <option value="XD">XD (XD)</option>
                </select>
            </div>
            <div>
                <label for="major2Select">第2メジャー:</label>
                <select id="major2Select">
                    <option value="IS">IS (情報システム)</option>
                    <option value="NC">NC (ネットワークコンピューティング)</option>
                    <option value="XD">XD (XD)</option>
                </select>
            </div>
        </div>

        <h2>現在の取得単位数</h2>
        <div class="input-section">
            <div>
                <label for="kyoyoUnits">教養教育科目:</label>
                <input type="number" id="kyoyoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="kogakuKisoUnits">工学基礎科目:</label>
                <input type="number" id="kogakuKisoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="johoKisoUnits">情報基礎科目:</label>
                <input type="number" id="johoKisoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="johoOyoUnits">情報応用科目:</label>
                <input type="number" id="johoOyoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="major1Units"><span id="major1Label">第1メジャー科目</span>:</label>
                <input type="number" id="major1Units" value="0" min="0"> 単位
            </div>
            <div>
                <label for="major2Units"><span id="major2Label">第2メジャー科目</span>:</label>
                <input type="number" id="major2Units" value="0" min="0"> 単位
            </div>
            <div>
                <label for="otherMajorUnits">その他メジャー科目:</label>
                <input type="number" id="otherMajorUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="sotsukenUnits">卒業研究:</label>
                <input type="number" id="sotsukenUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="jiyuSentakuUnits">自由選択科目:</label>
                <input type="number" id="jiyuSentakuUnits" value="0" min="0"> 単位
            </div>
        </div>

        <button onclick="updateCalculations()">計算する</button>

        <div class="results-section">
            <h2>計算結果</h2>
            <div>
                <span class="result-item">教養教育科目 残り:</span> <span id="resultKyoyo">0</span> 単位
            </div>
            <div>
                <span class="result-item">工学基礎科目 残り:</span> <span id="resultKogakuKiso">0</span> 単位
            </div>
            <div>
                <span class="result-item">情報基礎科目 残り:</span> <span id="resultJohoKiso">0</span> 単位
            </div>
            <div>
                <span class="result-item">情報応用科目 残り:</span> <span id="resultJohoOyo">0</span> 単位
            </div>
            <div>
                <span class="result-item"><span id="resultMajor1Label">第1メジャー科目</span> 残り:</span> <span id="resultMajor1">0</span> 単位
            </div>
            <div>
                <span class="result-item"><span id="resultMajor2Label">第2メジャー科目</span> 残り:</span> <span id="resultMajor2">0</span> 単位
            </div>
            <div>
                <span class="result-item">その他メジャー科目 残り:</span> <span id="resultOtherMajor">0</span> 単位
            </div>
            <div>
                <span class="result-item">卒業研究 残り:</span> <span id="resultSotsuken">0</span> 単位
            </div>
            <div>
                <span class="result-item">自由選択科目 残り:</span> <span id="resultJiyuSentaku">0</span> 単位
            </div>
        </div>

        <div class="total-summary">
            <h3>全体の単位状況</h3>
            <div>
                <span class="result-item">全体の取得済み単位数:</span> <span id="resultTotalAcquired">0</span> 単位
            </div>
            <div>
                <span class="result-item">全体の残りの単位数:</span> <span id="resultTotalRemaining">0</span> 単位
            </div>
        </div>

        <div class="chart-container">
            <h2>各科目の達成状況グラフ</h2>
            <canvas id="tanikeisanChart"></canvas>
        </div>

        <div class="navigation">
            <a href="tanisimulation.html">単位取得計画シミュレーションへ</a>
        </div>
    </div>

    <script>
        let targetUnits = {
            kyoyo: 24,         // 教養教育科目
            kogakuKiso: 16,    // 工学基礎科目
            johoKiso: 12,      // 情報基礎科目
            johoOyo: 4,        // 情報応用科目
            major1: 28,        // 第1メジャー科目 (デフォルト)
            major2: 14,        // 第2メジャー科目 (デフォルト)
            otherMajor: 10,    // その他メジャー科目
            sotsuken: 8,       // 卒業研究
            jiyuSentaku: 8     // 自由選択科目
        };

        const majorTargetUnits = {
            IS: { major1: 28, major2: 14 },
            NC: { major1: 26, major2: 12 },
            XD: { major1: 30, major2: 16 }
        };

        let tanikeisanChart;

        function calculateUnitsWithConversion(initialAcquiredUnits) {
            const currentAcquired = { ...initialAcquiredUnits };

            const major1Overflow = Math.max(0, currentAcquired.major1 - targetUnits.major1);
            if (major1Overflow > 0) {
                currentAcquired.otherMajor += major1Overflow;
                currentAcquired.major1 = targetUnits.major1;
            }

            const major2Overflow = Math.max(0, currentAcquired.major2 - targetUnits.major2);
            if (major2Overflow > 0) {
                currentAcquired.otherMajor += major2Overflow;
                currentAcquired.major2 = targetUnits.major2;
            }

            const kyoyoOverflow = Math.max(0, currentAcquired.kyoyo - targetUnits.kyoyo);
            if (kyoyoOverflow > 0) {
                currentAcquired.jiyuSentaku += kyoyoOverflow;
                currentAcquired.kyoyo = targetUnits.kyoyo;
            }

            const kogakuKisoOverflow = Math.max(0, currentAcquired.kogakuKiso - targetUnits.kogakuKiso);
            if (kogakuKisoOverflow > 0) {
                currentAcquired.jiyuSentaku += kogakuKisoOverflow;
                currentAcquired.kogakuKiso = targetUnits.kogakuKiso;
            }

            const johoKisoOverflow = Math.max(0, currentAcquired.johoKiso - targetUnits.johoKiso);
            if (johoKisoOverflow > 0) {
                currentAcquired.jiyuSentaku += johoKisoOverflow;
                currentAcquired.johoKiso = targetUnits.johoKiso;
            }

            const johoOyoOverflow = Math.max(0, currentAcquired.johoOyo - targetUnits.johoOyo);
            if (johoOyoOverflow > 0) {
                currentAcquired.jiyuSentaku += johoOyoOverflow;
                currentAcquired.johoOyo = targetUnits.johoOyo;
            }

            const otherMajorOverflow = Math.max(0, currentAcquired.otherMajor - targetUnits.otherMajor);
            if (otherMajorOverflow > 0) {
                currentAcquired.jiyuSentaku += otherMajorOverflow;
                currentAcquired.otherMajor = targetUnits.otherMajor;
            }

            const finalResults = {};
            let totalAcquiredForGraduation = 0;
            let totalRemainingSum = 0;

            for (const category in targetUnits) {
                if (targetUnits.hasOwnProperty(category)) {
                    if (category !== 'jiyuSentaku') {
                        const finalAcquiredForCategory = Math.min(currentAcquired[category], targetUnits[category]);
                        finalResults[category] = Math.max(0, targetUnits[category] - finalAcquiredForCategory);
                        totalAcquiredForGraduation += finalAcquiredForCategory;
                    }
                }
            }

            finalResults.jiyuSentaku = Math.max(0, targetUnits.jiyuSentaku - currentAcquired.jiyuSentaku);
            totalAcquiredForGraduation += currentAcquired.jiyuSentaku;

            finalResults.totalAcquired = totalAcquiredForGraduation;

            let recalculatedTotalRemaining = 0;
            for (const category in finalResults) {
                if (finalResults.hasOwnProperty(category) && category !== 'totalAcquired' && category !== 'totalRemaining') {
                    recalculatedTotalRemaining += finalResults[category];
                }
            }
            finalResults.totalRemaining = recalculatedTotalRemaining;

            finalResults.acquiredCategoryUnits = {};
            for (const category in targetUnits) {
                finalResults.acquiredCategoryUnits[category] = currentAcquired[category];
            }

            return finalResults;
        }

        function updateMajorTargetsAndLabels() {
            const major1 = document.getElementById('major1Select').value;
            const major2 = document.getElementById('major2Select').value;

            targetUnits.major1 = majorTargetUnits[major1].major1;
            targetUnits.major2 = majorTargetUnits[major2].major2;

            document.getElementById('major1Label').textContent = `第1メジャー科目 (${major1})`;
            document.getElementById('major2Label').textContent = `第2メジャー科目 (${major2})`;
            document.getElementById('resultMajor1Label').textContent = `第1メジャー科目 (${major1})`;
            document.getElementById('resultMajor2Label').textContent = `第2メジャー科目 (${major2})`;

            // 単位の計算とグラフ更新をここで呼び出す
            updateCalculations();
        }

        function updateCalculations() {
            const acquiredUnits = {
                kyoyo: parseInt(document.getElementById('kyoyoUnits').value) || 0,
                kogakuKiso: parseInt(document.getElementById('kogakuKisoUnits').value) || 0,
                johoKiso: parseInt(document.getElementById('johoKisoUnits').value) || 0,
                johoOyo: parseInt(document.getElementById('johoOyoUnits').value) || 0,
                major1: parseInt(document.getElementById('major1Units').value) || 0,
                major2: parseInt(document.getElementById('major2Units').value) || 0,
                otherMajor: parseInt(document.getElementById('otherMajorUnits').value) || 0,
                sotsuken: parseInt(document.getElementById('sotsukenUnits').value) || 0,
                jiyuSentaku: parseInt(document.getElementById('jiyuSentakuUnits').value) || 0
            };

            const dataToSave = {
                acquiredUnits: acquiredUnits,
                selectedMajors: {
                    major1: document.getElementById('major1Select').value,
                    major2: document.getElementById('major2Select').value
                }
            };
            localStorage.setItem('tanikeisanData', JSON.stringify(dataToSave));
            console.log('単位データとメジャー選択をローカルストレージに保存しました:', dataToSave);

            const results = calculateUnitsWithConversion(acquiredUnits);

            document.getElementById('resultKyoyo').textContent = results.kyoyo;
            document.getElementById('resultKogakuKiso').textContent = results.kogakuKiso;
            document.getElementById('resultJohoKiso').textContent = results.johoKiso;
            document.getElementById('resultJohoOyo').textContent = results.johoOyo;
            document.getElementById('resultMajor1').textContent = results.major1;
            document.getElementById('resultMajor2').textContent = results.major2;
            document.getElementById('resultOtherMajor').textContent = results.otherMajor;
            document.getElementById('resultSotsuken').textContent = results.sotsuken;
            document.getElementById('resultJiyuSentaku').textContent = results.jiyuSentaku;

            document.getElementById('resultTotalAcquired').textContent = results.totalAcquired;
            document.getElementById('resultTotalRemaining').textContent = results.totalRemaining;

            updateTanikeisanChart(results.acquiredCategoryUnits);
        }

        function updateTanikeisanChart(acquiredDataRaw) {
            const ctx = document.getElementById('tanikeisanChart').getContext('2d');
            
            const labels = Object.keys(targetUnits).map(key => {
                switch(key) {
                    case 'kyoyo': return '教養教育科目';
                    case 'kogakuKiso': return '工学基礎科目';
                    case 'johoKiso': return '情報基礎科目';
                    case 'johoOyo': return '情報応用科目';
                    case 'major1': return `第1メジャー科目 (${document.getElementById('major1Select').value})`;
                    case 'major2': return `第2メジャー科目 (${document.getElementById('major2Select').value})`;
                    case 'otherMajor': return 'その他メジャー科目';
                    case 'sotsuken': return '卒業研究';
                    case 'jiyuSentaku': return '自由選択科目';
                    default: return key;
                }
            });
            
            const acquiredDataForChart = Object.keys(targetUnits).map(key => {
                return Math.min(acquiredDataRaw[key], targetUnits[key]);
            });

            const targetData = Object.keys(targetUnits).map(key => {
                return targetUnits[key];
            });

            if (tanikeisanChart) {
                tanikeisanChart.destroy();
            }

            tanikeisanChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '目標単位数',
                        data: targetData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: '現在の取得済み単位数',
                        data: acquiredDataForChart,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '単位数'
                            },
                            ticks: {
                                stepSize: 1
                            },
                            max: Math.max(...targetData) + 2 // Ensure max value is sufficient
                        },
                        y: {
                            stacked: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.x;
                                    const categoryKey = Object.keys(targetUnits)[context.dataIndex];
                                    const target = targetUnits[categoryKey];
                                    
                                    if (context.dataset.label === '目標単位数') {
                                        return label + value + '単位';
                                    } else {
                                        const remaining = Math.max(0, target - value);
                                        return label + value + '単位 (残り: ' + remaining + '単位)';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            const savedData = localStorage.getItem('tanikeisanData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                const acquiredUnits = parsedData.acquiredUnits;
                const selectedMajors = parsedData.selectedMajors;

                console.log('ローカルストレージから単位データとメジャー選択を読み込みました:', parsedData);
                
                document.getElementById('kyoyoUnits').value = acquiredUnits.kyoyo || 0;
                document.getElementById('kogakuKisoUnits').value = acquiredUnits.kogakuKiso || 0;
                document.getElementById('johoKisoUnits').value = acquiredUnits.johoKiso || 0;
                document.getElementById('johoOyoUnits').value = acquiredUnits.johoOyo || 0;
                document.getElementById('major1Units').value = acquiredUnits.major1 || 0;
                document.getElementById('major2Units').value = acquiredUnits.major2 || 0;
                document.getElementById('otherMajorUnits').value = acquiredUnits.otherMajor || 0;
                document.getElementById('sotsukenUnits').value = acquiredUnits.sotsuken || 0;
                document.getElementById('jiyuSentakuUnits').value = acquiredUnits.jiyuSentaku || 0;

                document.getElementById('major1Select').value = selectedMajors.major1 || 'IS';
                document.getElementById('major2Select').value = selectedMajors.major2 || 'IS';

            } else {
                console.warn('ローカルストレージに単位データが見つかりませんでした。初期値を使用します。');
                // 初回アクセス時など、データがない場合のデフォルト設定
                document.getElementById('major1Select').value = 'IS';
                document.getElementById('major2Select').value = 'IS';
            }

            document.getElementById('major1Select').addEventListener('change', updateMajorTargetsAndLabels);
            document.getElementById('major2Select').addEventListener('change', updateMajorTargetsAndLabels);

            // ページロード時、またはデータ読み込み後に計算とグラフ更新を一度実行
            // updateMajorTargetsAndLabels() の中で updateCalculations() が呼ばれるため、これを実行すればOK
            updateMajorTargetsAndLabels(); 
        };
    </script>
</body>
</html>