<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単位取得計画シミュレーション</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        /* (スタイルは変更なしなので省略) */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 950px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        p { margin-bottom: 15px; }
        .input-section div, .display-section div { margin-bottom: 10px; display: flex; align-items: center; }
        .input-section label, .display-section label { flex: 0 0 220px; margin-right: 10px; font-weight: bold; color: #555; }
        .input-section input[type="number"] { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; max-width: 80px; }
        .display-unit-value { flex: 1; padding: 8px; border: 1px solid #eee; border-radius: 4px; max-width: 80px; background-color: #f9f9f9; color: #666; text-align: right;}

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #0056b3; }
        .results-section { margin-top: 20px; }
        .results-section div { margin-bottom: 8px; }
        .result-item { font-weight: bold; color: #0056b3; display: inline-block; width: 220px; }
        .total-summary { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .total-summary .result-item { color: #d9534f; }
        .total-summary #totalSimulatedAcquired { color: #28a745; }
        .chart-container {
            width: 100%;
            max-width: 800px;
            margin: 30px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
        }
        .navigation { margin-top: 30px; text-align: center; }
        .navigation a {
            display: inline-block;
            padding: 10px 15px;
            margin: 0 10px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .navigation a:hover {
            background-color: #5a6268;
        }

        .subject-list-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .subject-item {
            display: grid;
            grid-template-columns: 20px 80px 80px 80px 100px 1fr 60px;
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .subject-item:last-child {
            border-bottom: none;
        }
        .subject-item label {
            margin: 0;
            font-weight: normal;
            flex: none;
        }
        .subject-item input[type="checkbox"] {
            margin: 0;
        }
        .subject-header {
            font-weight: bold;
            background-color: #e2e2e2;
            padding: 8px 0;
            border-bottom: 2px solid #ccc;
            display: grid;
            grid-template-columns: 20px 80px 80px 80px 100px 1fr 60px;
            gap: 10px;
        }
        .subject-header div {
            text-align: center;
        }
        .subject-header div:nth-child(6) { text-align: left; }
        .subject-header div:nth-child(7) { text-align: center; }
        .subject-item .units {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>単位取得計画シミュレーション</h1>

        <p>現在までの取得単位と、**これから取得する予定の単位**を入力して、卒業要件の達成状況をシミュレーションできます。</p>

        <h2>現在の取得単位数（前ページから自動読み込み）</h2>
        <div class="display-section current-units-display">
            <div>
                <label>教養教育科目（現在）:</label>
                <span id="displayInitialKyoyoUnits" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label>工学基礎科目（現在）:</label>
                <span id="displayInitialKogakuKisoUnits" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label>情報基礎科目（現在）:</label>
                <span id="displayInitialJohoKisoUnits" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label>情報応用科目（現在）:</label>
                <span id="displayInitialJohoOyoUnits" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label><span id="displayInitialMajor1Label">第1メジャー科目</span>（現在）:</label>
                <span id="displayInitialMajor1Units" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label><span id="displayInitialMajor2Label">第2メジャー科目</span>（現在）:</label>
                <span id="displayInitialMajor2Units" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label>その他メジャー科目（現在）:</label>
                <span id="displayInitialOtherMajorUnits" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label>卒業研究（現在）:</label>
                <span id="displayInitialSotsukenUnits" class="display-unit-value">0</span> 単位
            </div>
            <div>
                <label>自由選択科目（現在）:</label>
                <span id="displayInitialJiyuSentakuUnits" class="display-unit-value">0</span> 単位
            </div>
        </div>

        <hr>
        <h2>これから取得する予定の科目一覧</h2>
        <p>これから取得する科目にチェックを入れて、予定単位を自動で加算できます。</p>
        <div class="subject-list-container">
            <div class="subject-header">
                <div></div>
                <div>Tag1</div>
                <div>Tag2</div>
                <div>Tag3</div>
                <div>Tag4</div>
                <div>科目名</div>
                <div>単位</div>
            </div>
            <div id="subjectListSimulation">
                </div>
        </div>
        <button onclick="applyPlannedSubjects()">チェックした科目を予定に加算</button>

        <hr>
        <h2>これから取得する予定の単位数</h2>
        <div class="input-section plan-units">
            <div>
                <label for="planKyoyoUnits">教養教育科目（予定）:</label>
                <input type="number" id="planKyoyoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planKogakuKisoUnits">工学基礎科目（予定）:</label>
                <input type="number" id="planKogakuKisoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planJohoKisoUnits">情報基礎科目（予定）:</label>
                <input type="number" id="planJohoKisoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planJohoOyoUnits">情報応用科目（予定）:</label>
                <input type="number" id="planJohoOyoUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planMajor1Units"><span id="planMajor1Label">第1メジャー科目</span>（予定）:</label>
                <input type="number" id="planMajor1Units" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planMajor2Units"><span id="planMajor2Label">第2メジャー科目</span>（予定）:</label>
                <input type="number" id="planMajor2Units" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planOtherMajorUnits">その他メジャー科目（予定）:</label>
                <input type="number" id="planOtherMajorUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planSotsukenUnits">卒業研究（予定）:</label>
                <input type="number" id="planSotsukenUnits" value="0" min="0"> 単位
            </div>
            <div>
                <label for="planJiyuSentakuUnits">自由選択科目（予定）:</label>
                <input type="number" id="planJiyuSentakuUnits" value="0" min="0"> 単位
            </div>
        </div>

        <button onclick="updateSimulation()">シミュレーションする</button>

        <div class="results-section">
            <h2>シミュレーション結果（最終的な単位状況）</h2>
            <div>
                <span class="result-item">教養教育科目 最終:</span> <span id="finalKyoyo">0</span> / <span id="targetKyoyo">24</span> 単位
            </div>
            <div>
                <span class="result-item">工学基礎科目 最終:</span> <span id="finalKogakuKiso">0</span> / <span id="targetKogakuKiso">16</span> 単位
            </div>
            <div>
                <span class="result-item">情報基礎科目 最終:</span> <span id="finalJohoKiso">0</span> / <span id="targetJohoKiso">12</span> 単位
            </div>
            <div>
                <span class="result-item">情報応用科目 最終:</span> <span id="finalJohoOyo">0</span> / <span id="targetJohoOyo">4</span> 単位
            </div>
            <div>
                <span class="result-item"><span id="finalMajor1Label">第1メジャー科目</span> 最終:</span> <span id="finalMajor1">0</span> / <span id="targetMajor1">28</span> 単位
            </div>
            <div>
                <span class="result-item"><span id="finalMajor2Label">第2メジャー科目</span> 最終:</span> <span id="finalMajor2">0</span> / <span id="targetMajor2">14</span> 単位
            </div>
            <div>
                <span class="result-item">その他メジャー科目 最終:</span> <span id="finalOtherMajor">0</span> / <span id="targetOtherMajor">10</span> 単位
            </div>
            <div>
                <span class="result-item">卒業研究 最終:</span> <span id="finalSotsuken">0</span> / <span id="targetSotsuken">8</span> 単位
            </div>
            <div>
                <span class="result-item">自由選択科目 最終:</span> <span id="finalJiyuSentaku">0</span> / <span id="targetJiyuSentaku">8</span> 単位
            </div>
        </div>

        <div class="total-summary">
            <h3>全体の単位状況</h3>
            <div>
                <span class="result-item">全体の目標取得単位数:</span> <span id="totalTarget">0</span> 単位
            </div>
            <div>
                <span class="result-item">全体のシミュレーション後取得済み単位数:</span> <span id="totalSimulatedAcquired">0</span> 単位
            </div>
            <div>
                <span class="result-item">全体のシミュレーション後残り単位数:</span> <span id="totalSimulatedRemaining">0</span> 単位
            </div>
        </div>

        <div class="chart-container">
            <h2>各科目の達成状況グラフ</h2>
            <canvas id="unitStatusChart"></canvas>
        </div>

        <div class="navigation">
            <a href="tanikeisan.html">単位計算に戻る</a>
        </div>
    </div>

    <script>
        const tagToCategoryMap = {
            // IS, NC, XD は動的に処理するためここでは定義しない
            "その他": "otherMajor",
            "連携": "jiyuSentaku",
            "教養": "kyoyo",
            "工学基礎": "kogakuKiso",
            "工学基礎必修": "kogakuKiso",
            "工学基礎必履修":"kogakuKiso",
            "情報基礎必修": "johoKiso",
            "情報応用必修": "johoOyo",
            "英語必修": "kyoyo",
            "誘い必修": "kyoyo",
            "情報処理必修": "kyoyo",
            "わかやま必修": "kyoyo"
        };

        let targetUnits = {
            kyoyo: 24, kogakuKiso: 16, johoKiso: 12, johoOyo: 4,
            major1: 28, major2: 14, otherMajor: 10, sotsuken: 8, jiyuSentaku: 8
        };

        const majorTargetUnits = {
            IS: { major1: 28, major2: 14 },
            NC: { major1: 28, major2: 14 },
            XD: { major1: 28, major2: 14 }
        };

        let tanisimulationChart; 
        let initialAcquiredUnitsFromStorage = {}; 
        let selectedMajorsFromStorage = { major1: 'IS', major2: 'IS' };
        let allSubjects = [];

        function calculateUnitsForSimulation(initialAcquiredUnits, plannedUnits) {
            const combinedAcquired = {};
            for (const category in targetUnits) {
                if (targetUnits.hasOwnProperty(category)) {
                    combinedAcquired[category] = (initialAcquiredUnits[category] || 0) + (plannedUnits[category] || 0);
                }
            }

            const currentAcquired = { ...combinedAcquired };

            const major1Overflow = Math.max(0, currentAcquired.major1 - targetUnits.major1);
            if (major1Overflow > 0) {
                currentAcquired.otherMajor += major1Overflow;
                currentAcquired.major1 = targetUnits.major1;
            }

            const major2Overflow = Math.max(0, currentAcquired.major2 - targetUnits.major2);
            if (major2Overflow > 0) {
                currentAcquired.otherMajor += major2Overflow;
                currentAcquired.major2 = targetUnits.major2;
            }

            const kyoyoOverflow = Math.max(0, currentAcquired.kyoyo - targetUnits.kyoyo);
            if (kyoyoOverflow > 0) {
                currentAcquired.jiyuSentaku += kyoyoOverflow;
                currentAcquired.kyoyo = targetUnits.kyoyo;
            }

            const kogakuKisoOverflow = Math.max(0, currentAcquired.kogakuKiso - targetUnits.kogakuKiso);
            if (kogakuKisoOverflow > 0) {
                currentAcquired.jiyuSentaku += kogakuKisoOverflow;
                currentAcquired.kogakuKiso = targetUnits.kogakuKiso;
            }

            const johoKisoOverflow = Math.max(0, currentAcquired.johoKiso - targetUnits.johoKiso);
            if (johoKisoOverflow > 0) {
                currentAcquired.jiyuSentaku += johoKisoOverflow;
                currentAcquired.johoKiso = targetUnits.johoKiso;
            }

            const johoOyoOverflow = Math.max(0, currentAcquired.johoOyo - targetUnits.johoOyo);
            if (johoOyoOverflow > 0) {
                currentAcquired.jiyuSentaku += johoOyoOverflow;
                currentAcquired.johoOyo = targetUnits.johoOyo;
            }

            const otherMajorOverflow = Math.max(0, currentAcquired.otherMajor - targetUnits.otherMajor);
            if (otherMajorOverflow > 0) {
                currentAcquired.jiyuSentaku += otherMajorOverflow;
                currentAcquired.otherMajor = targetUnits.otherMajor;
            }

            const finalResults = {};
            let totalAcquiredForGraduation = 0;
            let totalRemainingSum = 0;
            let totalTargetUnitsSum = 0;

            for (const category in targetUnits) {
                if (targetUnits.hasOwnProperty(category)) {
                    const finalAcquiredForCategory = Math.min(currentAcquired[category], targetUnits[category]);
                    
                    finalResults[category] = Math.max(0, targetUnits[category] - finalAcquiredForCategory);
                    
                    if (category !== 'jiyuSentaku') {
                        totalAcquiredForGraduation += finalAcquiredForCategory;
                    }
                    totalTargetUnitsSum += targetUnits[category];
                }
            }
            
            finalResults.jiyuSentaku = Math.max(0, targetUnits.jiyuSentaku - currentAcquired.jiyuSentaku);
            totalAcquiredForGraduation += currentAcquired.jiyuSentaku;

            finalResults.totalAcquired = totalAcquiredForGraduation;

            for (const category in finalResults) {
                if (finalResults.hasOwnProperty(category) && category !== 'totalAcquired' && category !== 'totalRemaining') {
                    totalRemainingSum += finalResults[category];
                }
            }
            finalResults.totalRemaining = totalRemainingSum;

            finalResults.finalCategoryAcquired = {};
            for (const category in targetUnits) {
                finalResults.finalCategoryAcquired[category] = Math.min(currentAcquired[category], targetUnits[category]);
            }
            finalResults.currentAcquired = currentAcquired;

            finalResults.totalTargetUnits = totalTargetUnitsSum;

            return finalResults;
        }

        function updateDisplayMajorLabelsAndTargets() {
            const savedData = localStorage.getItem('tanikeisanData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                selectedMajorsFromStorage = parsedData.selectedMajors || { major1: 'IS', major2: 'IS' };
            } else {
                selectedMajorsFromStorage = { major1: 'IS', major2: 'IS' };
            }

            targetUnits.major1 = majorTargetUnits[selectedMajorsFromStorage.major1].major1;
            targetUnits.major2 = majorTargetUnits[selectedMajorsFromStorage.major2].major2;

            document.getElementById('displayInitialMajor1Label').textContent = `第1メジャー科目 (${selectedMajorsFromStorage.major1})`;
            document.getElementById('displayInitialMajor2Label').textContent = `第2メジャー科目 (${selectedMajorsFromStorage.major2})`;
            document.getElementById('planMajor1Label').textContent = `第1メジャー科目 (${selectedMajorsFromStorage.major1})`;
            document.getElementById('planMajor2Label').textContent = `第2メジャー科目 (${selectedMajorsFromStorage.major2})`;
            document.getElementById('finalMajor1Label').textContent = `第1メジャー科目 (${selectedMajorsFromStorage.major1})`;
            document.getElementById('finalMajor2Label').textContent = `第2メジャー科目 (${selectedMajorsFromStorage.major2})`;
        }


        function updateSimulation() {
            const initialUnits = initialAcquiredUnitsFromStorage; 

            const plannedUnits = {
                kyoyo: parseInt(document.getElementById('planKyoyoUnits').value) || 0,
                kogakuKiso: parseInt(document.getElementById('planKogakuKisoUnits').value) || 0,
                johoKiso: parseInt(document.getElementById('planJohoKisoUnits').value) || 0,
                johoOyo: parseInt(document.getElementById('planJohoOyoUnits').value) || 0,
                major1: parseInt(document.getElementById('planMajor1Units').value) || 0,
                major2: parseInt(document.getElementById('planMajor2Units').value) || 0,
                otherMajor: parseInt(document.getElementById('planOtherMajorUnits').value) || 0,
                sotsuken: parseInt(document.getElementById('planSotsukenUnits').value) || 0,
                jiyuSentaku: parseInt(document.getElementById('planJiyuSentakuUnits').value) || 0
            };

            const dataToSave = {
                acquiredUnits: initialAcquiredUnitsFromStorage,
                selectedMajors: selectedMajorsFromStorage,
                plannedUnits: plannedUnits,
                checkedPlannedSubjects: getCheckedPlannedSubjectsState()
            };
            localStorage.setItem('tanisimulationData', JSON.stringify(dataToSave));
            console.log('シミュレーションデータとチェック状態をローカルストレージに保存しました:', dataToSave);


            const results = calculateUnitsForSimulation(initialUnits, plannedUnits);

            document.getElementById('finalKyoyo').textContent = Math.min(results.currentAcquired.kyoyo, targetUnits.kyoyo);
            document.getElementById('finalKogakuKiso').textContent = Math.min(results.currentAcquired.kogakuKiso, targetUnits.kogakuKiso);
            document.getElementById('finalJohoKiso').textContent = Math.min(results.currentAcquired.johoKiso, targetUnits.johoKiso);
            document.getElementById('finalJohoOyo').textContent = Math.min(results.currentAcquired.johoOyo, targetUnits.johoOyo);
            document.getElementById('finalMajor1').textContent = Math.min(results.currentAcquired.major1, targetUnits.major1);
            document.getElementById('finalMajor2').textContent = Math.min(results.currentAcquired.major2, targetUnits.major2);
            document.getElementById('finalOtherMajor').textContent = Math.min(results.currentAcquired.otherMajor, targetUnits.otherMajor);
            document.getElementById('finalSotsuken').textContent = Math.min(results.currentAcquired.sotsuken, targetUnits.sotsuken);
            document.getElementById('finalJiyuSentaku').textContent = Math.min(results.currentAcquired.jiyuSentaku, targetUnits.jiyuSentaku);

            document.getElementById('targetKyoyo').textContent = targetUnits.kyoyo;
            document.getElementById('targetKogakuKiso').textContent = targetUnits.kogakuKiso;
            document.getElementById('targetJohoKiso').textContent = targetUnits.johoKiso;
            document.getElementById('targetJohoOyo').textContent = targetUnits.johoOyo;
            document.getElementById('targetMajor1').textContent = targetUnits.major1;
            document.getElementById('targetMajor2').textContent = targetUnits.major2;
            document.getElementById('targetOtherMajor').textContent = targetUnits.otherMajor;
            document.getElementById('targetSotsuken').textContent = targetUnits.sotsuken;
            document.getElementById('targetJiyuSentaku').textContent = targetUnits.jiyuSentaku;

            document.getElementById('totalTarget').textContent = results.totalTargetUnits;
            document.getElementById('totalSimulatedAcquired').textContent = results.totalAcquired;
            document.getElementById('totalSimulatedRemaining').textContent = results.totalRemaining;

            updateSimulatedChart(results.finalCategoryAcquired);
        }

        function updateSimulatedChart(data) {
            const ctx = document.getElementById('unitStatusChart').getContext('2d');
            const labels = Object.keys(targetUnits).map(key => {
                switch(key) {
                    case 'kyoyo': return '教養教育科目';
                    case 'kogakuKiso': return '工学基礎科目';
                    case 'johoKiso': return '情報基礎科目';
                    case 'johoOyo': return '情報応用科目';
                    case 'major1': return `第1メジャー科目 (${selectedMajorsFromStorage.major1})`;
                    case 'major2': return `第2メジャー科目 (${selectedMajorsFromStorage.major2})`;
                    case 'otherMajor': return 'その他メジャー科目';
                    case 'sotsuken': return '卒業研究';
                    case 'jiyuSentaku': return '自由選択科目';
                    default: return key;
                }
            });
            
            const acquiredData = Object.keys(targetUnits).map(key => {
                return data[key];
            });

            const targetData = Object.keys(targetUnits).map(key => {
                return targetUnits[key];
            });

            if (tanisimulationChart) {
                tanisimulationChart.destroy();
            }

            tanisimulationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '目標単位数',
                        data: targetData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'シミュレーション後の取得単位数',
                        data: acquiredData,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '単位数'
                            },
                            ticks: {
                                stepSize: 1
                            },
                            max: Math.max(...targetData) + 2
                        },
                        y: {
                            stacked: false
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.x;
                                    const categoryKey = Object.keys(targetUnits)[context.dataIndex];
                                    const target = targetUnits[categoryKey];
                                    
                                    if (context.dataset.label === '目標単位数') {
                                        return label + value + '単位';
                                    } else {
                                        const remaining = Math.max(0, target - value);
                                        return label + value + '単位 (残り: ' + remaining + '単位)';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 科目データをFirebaseから読み込み、表示する関数
        function loadSubjectsForSimulation() {
            const subjectsRef = database.ref('syllabus_subjects');
            subjectsRef.on('value', (snapshot) => {
                const subjectsData = snapshot.val();
                const subjectListDiv = document.getElementById('subjectListSimulation');
                subjectListDiv.innerHTML = '';
                allSubjects = [];

                if (subjectsData) {
                    allSubjects = Object.keys(subjectsData).map(key => ({
                        id: key,
                        ...subjectsData[key]
                    }));

                    allSubjects.forEach(subject => {
                        console.log("科目データ (tanisimulation.html):", subject); // デバッグ用にログ出力

                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('subject-item');
                        itemDiv.dataset.subjectId = subject.id;

                        const checkboxIdPrefix = 'sim-chk'; // tanisimulation.html 用のプレフィックス

                        // 最初のカラムにすべてのチェックボックスをまとめる
                        let checkboxesInFirstColumn = '';
                        if (subject.tag1) {
                            checkboxesInFirstColumn += `<input type="checkbox" id="${checkboxIdPrefix}-${subject.id}-tag1" data-tag="${subject.tag1}" data-units="${subject.units}" data-subject-id="${subject.id}" onchange="handlePlannedCheckboxChange(this)">`;
                        }
                        if (subject.tag2) {
                            checkboxesInFirstColumn += `<input type="checkbox" id="${checkboxIdPrefix}-${subject.id}-tag2" data-tag="${subject.tag2}" data-units="${subject.units}" data-subject-id="${subject.id}" onchange="handlePlannedCheckboxChange(this)">`;
                        }
                        if (subject.tag3) {
                            checkboxesInFirstColumn += `<input type="checkbox" id="${checkboxIdPrefix}-${subject.id}-tag3" data-tag="${subject.tag3}" data-units="${subject.units}" data-subject-id="${subject.id}" onchange="handlePlannedCheckboxChange(this)">`;
                        }

                        itemDiv.innerHTML = `
                            <div>${checkboxesInFirstColumn}</div> <div>${subject.tag1 || ''}</div>     <div>${subject.tag2 || ''}</div>     <div>${subject.tag3 || ''}</div>     <div>${subject.tag4 || ''}</div>     <div>${subject.name || ''}</div>     <div class="units">${subject.units || 0}</div> `;
                        subjectListDiv.appendChild(itemDiv);
                    });
                } else {
                    subjectListDiv.innerHTML = '<p>科目データがありません。</p>';
                }
                restoreCheckedPlannedSubjectsState();
            }, (error) => {
                console.error("Firebaseから科目データの読み込みに失敗しました:", error);
                alert("科目データの読み込みに失敗しました。インターネット接続を確認してください。");
            });
        }

        function getCheckedPlannedSubjectsState() {
            const checkedStates = {};
            document.querySelectorAll('#subjectListSimulation input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    checkedStates[checkbox.id] = true;
                }
            });
            return checkedStates;
        }

        function restoreCheckedPlannedSubjectsState() {
            const savedData = localStorage.getItem('tanisimulationData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                const checkedPlannedSubjects = parsedData.checkedPlannedSubjects || {};
                
                document.querySelectorAll('#subjectListSimulation input[type="checkbox"]').forEach(checkbox => {
                    if (checkedPlannedSubjects[checkbox.id]) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false;
                    }
                });
            }
        }

        function handlePlannedCheckboxChange(changedCheckbox) {
            const subjectId = changedCheckbox.dataset.subjectId;
            const checkboxesForSubject = document.querySelectorAll(`input[type="checkbox"][data-subject-id="${subjectId}"]`);

            if (changedCheckbox.checked) {
                checkboxesForSubject.forEach(cb => {
                    if (cb !== changedCheckbox) {
                        cb.checked = false;
                    }
                });
            }
            // チェックボックスの状態が変更されたら、自動的に再計算する
            applyPlannedSubjects();
        }

        function applyPlannedSubjects() {
            let tempPlannedUnits = {
                kyoyo: 0, kogakuKiso: 0, johoKiso: 0, johoOyo: 0,
                major1: 0, major2: 0, otherMajor: 0, sotsuken: 0, jiyuSentaku: 0
            };

            const major1Selected = selectedMajorsFromStorage.major1;
            const major2Selected = selectedMajorsFromStorage.major2;
            const majorTags = ['IS', 'NC', 'XD']; // すべてのメジャー関連タグ

            document.querySelectorAll('#subjectListSimulation input[type="checkbox"]:checked').forEach(checkbox => {
                const tag = checkbox.dataset.tag;
                const units = parseInt(checkbox.dataset.units) || 0; // ここで単位数を数値として取得

                let category = tagToCategoryMap[tag]; // まずは既存のマップで確認

                // メジャー関連のタグの場合の特殊処理
                if (majorTags.includes(tag)) {
                    if (tag === major1Selected) {
                        category = 'major1';
                    } else if (tag === major2Selected) {
                        category = 'major2';
                    } else {
                        // 選択されなかったメジャー科目は「その他メジャー科目」として扱う
                        category = 'otherMajor';
                    }
                }

                if (tempPlannedUnits.hasOwnProperty(category)) {
                    tempPlannedUnits[category] += units;
                } else {
                    console.warn(`不明なカテゴリ: ${category} (タグ: ${tag})`);
                }
            });

            document.getElementById('planKyoyoUnits').value = tempPlannedUnits.kyoyo;
            document.getElementById('planKogakuKisoUnits').value = tempPlannedUnits.kogakuKiso;
            document.getElementById('planJohoKisoUnits').value = tempPlannedUnits.johoKiso;
            document.getElementById('planJohoOyoUnits').value = tempPlannedUnits.johoOyo;
            document.getElementById('planMajor1Units').value = tempPlannedUnits.major1;
            document.getElementById('planMajor2Units').value = tempPlannedUnits.major2;
            document.getElementById('planOtherMajorUnits').value = tempPlannedUnits.otherMajor;
            document.getElementById('planSotsukenUnits').value = tempPlannedUnits.sotsuken;
            document.getElementById('planJiyuSentakuUnits').value = tempPlannedUnits.jiyuSentaku;

            updateSimulation();
        }

        window.onload = function() {
            const savedTanikeisanData = localStorage.getItem('tanikeisanData');
            if (savedTanikeisanData) {
                const parsedTanikeisanData = JSON.parse(savedTanikeisanData);
                initialAcquiredUnitsFromStorage = parsedTanikeisanData.acquiredUnits || {};
                selectedMajorsFromStorage = parsedTanikeisanData.selectedMajors || { major1: 'IS', major2: 'IS' };

                console.log('シミュレーションページでローカルストレージから単位データとメジャー選択を読み込みました (tanikeisanData):', parsedTanikeisanData);
                
                document.getElementById('displayInitialKyoyoUnits').textContent = initialAcquiredUnitsFromStorage.kyoyo || 0;
                document.getElementById('displayInitialKogakuKisoUnits').textContent = initialAcquiredUnitsFromStorage.kogakuKiso || 0;
                document.getElementById('displayInitialJohoKisoUnits').textContent = initialAcquiredUnitsFromStorage.johoKiso || 0;
                document.getElementById('displayInitialJohoOyoUnits').textContent = initialAcquiredUnitsFromStorage.johoOyo || 0;
                document.getElementById('displayInitialMajor1Units').textContent = initialAcquiredUnitsFromStorage.major1 || 0;
                document.getElementById('displayInitialMajor2Units').textContent = initialAcquiredUnitsFromStorage.major2 || 0;
                document.getElementById('displayInitialOtherMajorUnits').textContent = initialAcquiredUnitsFromStorage.otherMajor || 0;
                document.getElementById('displayInitialSotsukenUnits').textContent = initialAcquiredUnitsFromStorage.sotsuken || 0;
                document.getElementById('displayInitialJiyuSentakuUnits').textContent = initialAcquiredUnitsFromStorage.jiyuSentaku || 0;
            } else {
                console.warn('ローカルストレージに単位データが見つかりませんでした。tanikeisan.html で単位を入力してください。');
                alert('単位データが見つかりません。まず「単位計算」ページで現在の取得単位を入力してください。');
                selectedMajorsFromStorage = { major1: 'IS', major2: 'IS' };
            }
            
            const savedTanisimulationData = localStorage.getItem('tanisimulationData');
            if (savedTanisimulationData) {
                const parsedTanisimulationData = JSON.parse(savedTanisimulationData);
                const plannedUnits = parsedTanisimulationData.plannedUnits || {};

                console.log('シミュレーションページでローカルストレージから予定単位データを読み込みました (tanisimulationData):', parsedTanisimulationData);

                document.getElementById('planKyoyoUnits').value = plannedUnits.kyoyo || 0;
                document.getElementById('planKogakuKisoUnits').value = plannedUnits.kogakuKiso || 0;
                document.getElementById('planJohoKisoUnits').value = plannedUnits.johoKiso || 0;
                document.getElementById('planJohoOyoUnits').value = plannedUnits.johoOyo || 0;
                document.getElementById('planMajor1Units').value = plannedUnits.major1 || 0;
                document.getElementById('planMajor2Units').value = plannedUnits.major2 || 0;
                document.getElementById('planOtherMajorUnits').value = plannedUnits.otherMajor || 0;
                document.getElementById('planSotsukenUnits').value = plannedUnits.sotsuken || 0;
                document.getElementById('planJiyuSentakuUnits').value = plannedUnits.jiyuSentaku || 0;
            } else {
                console.warn('ローカルストレージにシミュレーション予定データが見つかりませんでした。初期値を使用します。');
            }

            updateDisplayMajorLabelsAndTargets();
            loadSubjectsForSimulation();
        };
    </script>
</body>
</html>